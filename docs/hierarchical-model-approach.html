<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 7 Hierarchical model approach | Source code and supporting information for _Predicting abundances from acoustic data: North Eastern Bird Communities</title>
  <meta name="description" content="Section 7 Hierarchical model approach | Source code and supporting information for _Predicting abundances from acoustic data: North Eastern Bird Communities" />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 7 Hierarchical model approach | Source code and supporting information for _Predicting abundances from acoustic data: North Eastern Bird Communities" />
  <meta property="og:type" content="book" />
  
  
  <meta name="github-repo" content="vjjan91/newHampshire-pointCount-acoustics" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 7 Hierarchical model approach | Source code and supporting information for _Predicting abundances from acoustic data: North Eastern Bird Communities" />
  
  
  

<meta name="author" content="Vijay Ramesh" />
<meta name="author" content="Pooja Panwar" />
<meta name="author" content="Orlando Acevedo-Charry" />
<meta name="author" content="Sharon Martinson" />
<meta name="author" content="Laurel Symes" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="calling-rates.html"/>
<link rel="next" href="another-example-with-hierarchical-model-approach---oven-in-katahdin-woods-and-waters.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#attribution"><i class="fa fa-check"></i><b>1.1</b> Attribution</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data-access"><i class="fa fa-check"></i><b>1.2</b> Data access</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#data-processing"><i class="fa fa-check"></i><b>1.3</b> Data processing</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-comparability.html"><a href="data-comparability.html"><i class="fa fa-check"></i><b>2</b> Data comparability</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data-comparability.html"><a href="data-comparability.html#load-necessary-libraries"><i class="fa fa-check"></i><b>2.1</b> Load necessary libraries</a></li>
<li class="chapter" data-level="2.2" data-path="data-comparability.html"><a href="data-comparability.html#loading-point-count-and-acoustic-data"><i class="fa fa-check"></i><b>2.2</b> Loading point count and acoustic data</a></li>
<li class="chapter" data-level="2.3" data-path="data-comparability.html"><a href="data-comparability.html#cleaning-up-point-count-data"><i class="fa fa-check"></i><b>2.3</b> Cleaning up point count data</a></li>
<li class="chapter" data-level="2.4" data-path="data-comparability.html"><a href="data-comparability.html#cleaning-up-acoustic-data"><i class="fa fa-check"></i><b>2.4</b> Cleaning up acoustic data</a></li>
<li class="chapter" data-level="2.5" data-path="data-comparability.html"><a href="data-comparability.html#creating-a-combined-dataset"><i class="fa fa-check"></i><b>2.5</b> Creating a combined dataset</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="subsetting-data-and-running-exploratory-data-analyses.html"><a href="subsetting-data-and-running-exploratory-data-analyses.html"><i class="fa fa-check"></i><b>3</b> Subsetting data and running exploratory data analyses</a>
<ul>
<li class="chapter" data-level="3.1" data-path="subsetting-data-and-running-exploratory-data-analyses.html"><a href="subsetting-data-and-running-exploratory-data-analyses.html#load-necessary-libraries-1"><i class="fa fa-check"></i><b>3.1</b> Load necessary libraries</a></li>
<li class="chapter" data-level="3.2" data-path="subsetting-data-and-running-exploratory-data-analyses.html"><a href="subsetting-data-and-running-exploratory-data-analyses.html#load-dataframe-containing-point-count-and-acoustic-data"><i class="fa fa-check"></i><b>3.2</b> Load dataframe containing point count and acoustic data</a></li>
<li class="chapter" data-level="3.3" data-path="subsetting-data-and-running-exploratory-data-analyses.html"><a href="subsetting-data-and-running-exploratory-data-analyses.html#estimate-total-abundance-and-richness-for-point-count-and-acoustic-data"><i class="fa fa-check"></i><b>3.3</b> Estimate total abundance and richness for point count and acoustic data</a></li>
<li class="chapter" data-level="3.4" data-path="subsetting-data-and-running-exploratory-data-analyses.html"><a href="subsetting-data-and-running-exploratory-data-analyses.html#creating-a-single-dataframe-prior-to-running-statistical-analysis"><i class="fa fa-check"></i><b>3.4</b> Creating a single dataframe prior to running statistical analysis</a></li>
<li class="chapter" data-level="3.5" data-path="subsetting-data-and-running-exploratory-data-analyses.html"><a href="subsetting-data-and-running-exploratory-data-analyses.html#filtering-criteria-for-species-inclusion"><i class="fa fa-check"></i><b>3.5</b> Filtering criteria for species inclusion</a></li>
<li class="chapter" data-level="3.6" data-path="subsetting-data-and-running-exploratory-data-analyses.html"><a href="subsetting-data-and-running-exploratory-data-analyses.html#explore-whether-time-of-day-shows-any-variation-in-abundancedetections"><i class="fa fa-check"></i><b>3.6</b> Explore whether time of day shows any variation in abundance/detections?</a></li>
<li class="chapter" data-level="3.7" data-path="subsetting-data-and-running-exploratory-data-analyses.html"><a href="subsetting-data-and-running-exploratory-data-analyses.html#examining-abundance-and-acoustic-detections-as-a-function-of-time-of-day-by-species"><i class="fa fa-check"></i><b>3.7</b> Examining abundance and acoustic detections as a function of time of day by species</a></li>
<li class="chapter" data-level="3.8" data-path="subsetting-data-and-running-exploratory-data-analyses.html"><a href="subsetting-data-and-running-exploratory-data-analyses.html#save-the-subsetted-data-to-file"><i class="fa fa-check"></i><b>3.8</b> Save the subsetted data to file</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="creating-study-area-map.html"><a href="creating-study-area-map.html"><i class="fa fa-check"></i><b>4</b> Creating study area map</a>
<ul>
<li class="chapter" data-level="4.1" data-path="creating-study-area-map.html"><a href="creating-study-area-map.html#load-necessary-libraries-2"><i class="fa fa-check"></i><b>4.1</b> Load necessary libraries</a></li>
<li class="chapter" data-level="4.2" data-path="creating-study-area-map.html"><a href="creating-study-area-map.html#load-associated-shapefiles-for-each-region-sampled"><i class="fa fa-check"></i><b>4.2</b> Load associated shapefiles for each region sampled</a></li>
<li class="chapter" data-level="4.3" data-path="creating-study-area-map.html"><a href="creating-study-area-map.html#download-natural-earth-layers"><i class="fa fa-check"></i><b>4.3</b> Download natural earth layers</a></li>
<li class="chapter" data-level="4.4" data-path="creating-study-area-map.html"><a href="creating-study-area-map.html#acadia-national-park"><i class="fa fa-check"></i><b>4.4</b> Acadia National Park</a></li>
<li class="chapter" data-level="4.5" data-path="creating-study-area-map.html"><a href="creating-study-area-map.html#hubbard-brook"><i class="fa fa-check"></i><b>4.5</b> Hubbard Brook</a></li>
<li class="chapter" data-level="4.6" data-path="creating-study-area-map.html"><a href="creating-study-area-map.html#katahdin-woods-and-waters"><i class="fa fa-check"></i><b>4.6</b> Katahdin Woods and Waters</a></li>
<li class="chapter" data-level="4.7" data-path="creating-study-area-map.html"><a href="creating-study-area-map.html#marsh-billings"><i class="fa fa-check"></i><b>4.7</b> Marsh Billings</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="abundance-vs.-acoustic-detections.html"><a href="abundance-vs.-acoustic-detections.html"><i class="fa fa-check"></i><b>5</b> Abundance vs. acoustic detections</a>
<ul>
<li class="chapter" data-level="5.1" data-path="abundance-vs.-acoustic-detections.html"><a href="abundance-vs.-acoustic-detections.html#load-necessary-libraries-3"><i class="fa fa-check"></i><b>5.1</b> Load necessary libraries</a></li>
<li class="chapter" data-level="5.2" data-path="abundance-vs.-acoustic-detections.html"><a href="abundance-vs.-acoustic-detections.html#load-dataframe-containing-data-that-is-already-filtered-for-a-subset-of-species"><i class="fa fa-check"></i><b>5.2</b> Load dataframe containing data that is already filtered for a subset of species</a></li>
<li class="chapter" data-level="5.3" data-path="abundance-vs.-acoustic-detections.html"><a href="abundance-vs.-acoustic-detections.html#correlations-between-abundance-and-detections"><i class="fa fa-check"></i><b>5.3</b> Correlations between abundance and detections</a></li>
<li class="chapter" data-level="5.4" data-path="abundance-vs.-acoustic-detections.html"><a href="abundance-vs.-acoustic-detections.html#scaling-of-predictors-and-determining-distribution-family"><i class="fa fa-check"></i><b>5.4</b> Scaling of predictors and determining distribution family</a></li>
<li class="chapter" data-level="5.5" data-path="abundance-vs.-acoustic-detections.html"><a href="abundance-vs.-acoustic-detections.html#generalized-linear-mixed-model-between-abundance-and-acoustic-detections"><i class="fa fa-check"></i><b>5.5</b> Generalized linear mixed model between abundance and acoustic detections</a></li>
<li class="chapter" data-level="5.6" data-path="abundance-vs.-acoustic-detections.html"><a href="abundance-vs.-acoustic-detections.html#model-diagnostics"><i class="fa fa-check"></i><b>5.6</b> Model diagnostics</a></li>
<li class="chapter" data-level="5.7" data-path="abundance-vs.-acoustic-detections.html"><a href="abundance-vs.-acoustic-detections.html#predict-abundance-given-detections"><i class="fa fa-check"></i><b>5.7</b> Predict abundance given detections</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="calling-rates.html"><a href="calling-rates.html"><i class="fa fa-check"></i><b>6</b> Calling rates</a>
<ul>
<li class="chapter" data-level="6.1" data-path="calling-rates.html"><a href="calling-rates.html#load-necessary-libraries-4"><i class="fa fa-check"></i><b>6.1</b> Load necessary libraries</a></li>
<li class="chapter" data-level="6.2" data-path="calling-rates.html"><a href="calling-rates.html#load-previous-model-object-and-filtered-data"><i class="fa fa-check"></i><b>6.2</b> Load previous model object and filtered data</a></li>
<li class="chapter" data-level="6.3" data-path="calling-rates.html"><a href="calling-rates.html#calculating-calling-rate"><i class="fa fa-check"></i><b>6.3</b> Calculating calling rate</a></li>
<li class="chapter" data-level="6.4" data-path="calling-rates.html"><a href="calling-rates.html#does-calling-rate-vary-as-a-function-of-number-of-individuals"><i class="fa fa-check"></i><b>6.4</b> Does calling rate vary as a function of number of individuals</a></li>
<li class="chapter" data-level="6.5" data-path="calling-rates.html"><a href="calling-rates.html#is-calling-rate-linked-to-the-fit-between-predicted-abundance-and-acoustic-detections"><i class="fa fa-check"></i><b>6.5</b> Is calling rate linked to the fit between predicted abundance and acoustic detections?</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="hierarchical-model-approach.html"><a href="hierarchical-model-approach.html"><i class="fa fa-check"></i><b>7</b> Hierarchical model approach</a>
<ul>
<li class="chapter" data-level="7.1" data-path="hierarchical-model-approach.html"><a href="hierarchical-model-approach.html#packages"><i class="fa fa-check"></i><b>7.1</b> Packages</a></li>
<li class="chapter" data-level="7.2" data-path="hierarchical-model-approach.html"><a href="hierarchical-model-approach.html#loading-and-exploring-data"><i class="fa fa-check"></i><b>7.2</b> Loading and exploring data</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="hierarchical-model-approach.html"><a href="hierarchical-model-approach.html#figures-of-the-data"><i class="fa fa-check"></i><b>7.2.1</b> Figures of the data</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="hierarchical-model-approach.html"><a href="hierarchical-model-approach.html#hierarchical-model-for-counts-with-two-observation-processes"><i class="fa fa-check"></i><b>7.3</b> Hierarchical model for counts with two observation processes</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="hierarchical-model-approach.html"><a href="hierarchical-model-approach.html#state-process-for-morning-expected-counts"><i class="fa fa-check"></i><b>7.3.1</b> State process for morning expected counts</a></li>
<li class="chapter" data-level="7.3.2" data-path="hierarchical-model-approach.html"><a href="hierarchical-model-approach.html#observation-process-for-morning-point-counts"><i class="fa fa-check"></i><b>7.3.2</b> Observation process for morning point counts</a></li>
<li class="chapter" data-level="7.3.3" data-path="hierarchical-model-approach.html"><a href="hierarchical-model-approach.html#observation-process-for-morning-acoustic-detections"><i class="fa fa-check"></i><b>7.3.3</b> Observation process for morning acoustic detections</a></li>
<li class="chapter" data-level="7.3.4" data-path="hierarchical-model-approach.html"><a href="hierarchical-model-approach.html#coding-observation-point-counts"><i class="fa fa-check"></i><b>7.3.4</b> Coding Observation point counts</a></li>
<li class="chapter" data-level="7.3.5" data-path="hierarchical-model-approach.html"><a href="hierarchical-model-approach.html#coding-acoustic-detections-counts"><i class="fa fa-check"></i><b>7.3.5</b> Coding Acoustic detections counts</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="another-example-with-hierarchical-model-approach---oven-in-katahdin-woods-and-waters.html"><a href="another-example-with-hierarchical-model-approach---oven-in-katahdin-woods-and-waters.html"><i class="fa fa-check"></i><b>8</b> Another example with hierarchical model approach - OVEN in Katahdin Woods and Waters</a>
<ul>
<li class="chapter" data-level="8.1" data-path="another-example-with-hierarchical-model-approach---oven-in-katahdin-woods-and-waters.html"><a href="another-example-with-hierarchical-model-approach---oven-in-katahdin-woods-and-waters.html#packages-1"><i class="fa fa-check"></i><b>8.1</b> Packages</a></li>
<li class="chapter" data-level="8.2" data-path="another-example-with-hierarchical-model-approach---oven-in-katahdin-woods-and-waters.html"><a href="another-example-with-hierarchical-model-approach---oven-in-katahdin-woods-and-waters.html#loading-and-exploring-data-1"><i class="fa fa-check"></i><b>8.2</b> Loading and exploring data</a></li>
<li class="chapter" data-level="8.3" data-path="another-example-with-hierarchical-model-approach---oven-in-katahdin-woods-and-waters.html"><a href="another-example-with-hierarchical-model-approach---oven-in-katahdin-woods-and-waters.html#hierarchical-model-for-counts-with-two-observation-processes-1"><i class="fa fa-check"></i><b>8.3</b> Hierarchical model for counts with two observation processes</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="another-example-with-hierarchical-model-approach---oven-in-katahdin-woods-and-waters.html"><a href="another-example-with-hierarchical-model-approach---oven-in-katahdin-woods-and-waters.html#coding-observation-point-counts-1"><i class="fa fa-check"></i><b>8.3.1</b> Coding Observation point counts</a></li>
<li class="chapter" data-level="8.3.2" data-path="another-example-with-hierarchical-model-approach---oven-in-katahdin-woods-and-waters.html"><a href="another-example-with-hierarchical-model-approach---oven-in-katahdin-woods-and-waters.html#coding-acoustic-detections-counts-1"><i class="fa fa-check"></i><b>8.3.2</b> Coding Acoustic detections counts</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Source code and supporting information for _Predicting abundances from acoustic data: North Eastern Bird Communities</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="hierarchical-model-approach" class="section level1 hasAnchor" number="7">
<h1><span class="header-section-number">Section 7</span> Hierarchical model approach<a href="hierarchical-model-approach.html#hierarchical-model-approach" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Here we want to evaluate the use of another approach for a hierarchical model of estimation of counts. First, we fit a dynamic autoregressive model to estimate stochastic counts that can be compared to conventional approaches (e.g., -mixture models). We can use this autoregressive model also to estimate the same latent counts from the acoustic detections data as observation process, including an extra parameter of scaling the acoustic activity (e.g., one individual singing more than a 1:1 relationship).</p>
<p>We try this option first with a single species in a single site. However, this can be further extrapolated to use multispecies models, from abundant species in the community to estimate parameters of rare ones (sharing some characteristics), such as Beta N-Mixture and Normal N-Mixture .</p>
<div id="packages" class="section level2 hasAnchor" number="7.1">
<h2><span class="header-section-number">7.1</span> Packages<a href="hierarchical-model-approach.html#packages" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="hierarchical-model-approach.html#cb34-1" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb34-2"><a href="hierarchical-model-approach.html#cb34-2" tabindex="-1"></a><span class="fu">library</span>(MetBrewer)</span>
<span id="cb34-3"><a href="hierarchical-model-approach.html#cb34-3" tabindex="-1"></a><span class="fu">library</span>(dclone)</span>
<span id="cb34-4"><a href="hierarchical-model-approach.html#cb34-4" tabindex="-1"></a><span class="fu">library</span>(mcmcplots)</span></code></pre></div>
</div>
<div id="loading-and-exploring-data" class="section level2 hasAnchor" number="7.2">
<h2><span class="header-section-number">7.2</span> Loading and exploring data<a href="hierarchical-model-approach.html#loading-and-exploring-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s load the file used in <code>01_data-comparability.Rmd</code> script.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="hierarchical-model-approach.html#cb35-1" tabindex="-1"></a>acous_count <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;results/pooled_pointCount_acoustic_data.csv&quot;</span>)</span>
<span id="cb35-2"><a href="hierarchical-model-approach.html#cb35-2" tabindex="-1"></a></span>
<span id="cb35-3"><a href="hierarchical-model-approach.html#cb35-3" tabindex="-1"></a>acous_count <span class="sc">|&gt;</span> <span class="co"># names()</span></span>
<span id="cb35-4"><a href="hierarchical-model-approach.html#cb35-4" tabindex="-1"></a>  <span class="fu">group_by</span>(common_name, data_type, site_name) <span class="sc">|&gt;</span></span>
<span id="cb35-5"><a href="hierarchical-model-approach.html#cb35-5" tabindex="-1"></a>  <span class="fu">count</span>() <span class="co">#|&gt; View() # use filter in RStudio</span></span></code></pre></div>
<p>Let’s work on the species-site combination of more data: Ovenbird in Marsh-Billings-Rockefeller NHP.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="hierarchical-model-approach.html#cb36-1" tabindex="-1"></a>acous_count_filt <span class="ot">&lt;-</span> acous_count <span class="sc">|&gt;</span></span>
<span id="cb36-2"><a href="hierarchical-model-approach.html#cb36-2" tabindex="-1"></a>  <span class="fu">filter</span>(common_name <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb36-3"><a href="hierarchical-model-approach.html#cb36-3" tabindex="-1"></a>    <span class="co">#&quot;American Crow&quot;,&quot;American Robin&quot;,&quot;Black-and-white Warbler&quot;,&quot;Black-capped Chickadee&quot;,&quot;Black-throated Blue Warbler&quot;,&quot;Black-throated Green Warbler&quot;,&quot;Blackburnian Warbler&quot;,&quot;Blue Jay&quot;,&quot;Blue-headed Vireo&quot;,&quot;Brown Creeper&quot;,&quot;Eastern Wood-Pewee&quot;,&quot;Golden-crowned Kinglet&quot;,&quot;Hermit Thrush&quot;,&quot;Northern Parula&quot;,</span></span>
<span id="cb36-4"><a href="hierarchical-model-approach.html#cb36-4" tabindex="-1"></a>    </span>
<span id="cb36-5"><a href="hierarchical-model-approach.html#cb36-5" tabindex="-1"></a>                            <span class="st">&quot;Ovenbird&quot;</span> </span>
<span id="cb36-6"><a href="hierarchical-model-approach.html#cb36-6" tabindex="-1"></a>                            </span>
<span id="cb36-7"><a href="hierarchical-model-approach.html#cb36-7" tabindex="-1"></a>                            <span class="co">#,&quot;Pine Warbler&quot;,&quot;Red-breasted Nuthatch&quot;,&quot;Red-eyed Vireo&quot;,&quot;Scarlet Tanager&quot;,&quot;Winter Wren&quot;,&quot;Yellow-bellied Sapsucker&quot;,&quot;Yellow-rumped Warbler&quot;</span></span>
<span id="cb36-8"><a href="hierarchical-model-approach.html#cb36-8" tabindex="-1"></a>                            ),</span>
<span id="cb36-9"><a href="hierarchical-model-approach.html#cb36-9" tabindex="-1"></a>    site_name <span class="sc">==</span> <span class="st">&quot;Marsh-Billings-Rockefeller NHP&quot;</span>)</span>
<span id="cb36-10"><a href="hierarchical-model-approach.html#cb36-10" tabindex="-1"></a><span class="fu">table</span>(acous_count_filt<span class="sc">$</span>common_name, acous_count_filt<span class="sc">$</span>data_type)</span></code></pre></div>
<p>The package <code>naniar</code> allow to see a good summar of NAs per column</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="hierarchical-model-approach.html#cb37-1" tabindex="-1"></a>naniar<span class="sc">::</span><span class="fu">miss_var_summary</span>(acous_count_filt)</span></code></pre></div>
<p>How to reconcile time of detection of each record?</p>
<p>While the <code>point_count</code> data include the <code>observation_time</code> variable, this information for the <code>acoustic_data</code> seems to be at the <code>begin_clock_time</code> variable. Let’s adjust this with the function <code>coalesce</code> from <code>dplyr</code> in <code>tidyverse</code>. Then, we can consolidate the “initial temporal window” per visit in each site_id with the detection time.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="hierarchical-model-approach.html#cb38-1" tabindex="-1"></a>acoust_count_summary <span class="ot">&lt;-</span> acous_count_filt <span class="sc">|&gt;</span></span>
<span id="cb38-2"><a href="hierarchical-model-approach.html#cb38-2" tabindex="-1"></a>  <span class="co"># dummy column to unify time of detection either by count or </span></span>
<span id="cb38-3"><a href="hierarchical-model-approach.html#cb38-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">detection_time =</span> <span class="fu">coalesce</span>(observation_time, begin_clock_time)) <span class="sc">|&gt;</span></span>
<span id="cb38-4"><a href="hierarchical-model-approach.html#cb38-4" tabindex="-1"></a>  <span class="co"># initial temporal window</span></span>
<span id="cb38-5"><a href="hierarchical-model-approach.html#cb38-5" tabindex="-1"></a>  <span class="fu">group_by</span>(site_id, date, visit_number) <span class="sc">|&gt;</span></span>
<span id="cb38-6"><a href="hierarchical-model-approach.html#cb38-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time_window =</span> <span class="fu">min</span>(hms<span class="sc">::</span><span class="fu">as_hms</span>(detection_time), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb38-7"><a href="hierarchical-model-approach.html#cb38-7" tabindex="-1"></a>         <span class="at">time_window =</span> hms<span class="sc">::</span><span class="fu">as_hms</span>(time_window)) <span class="sc">|&gt;</span></span>
<span id="cb38-8"><a href="hierarchical-model-approach.html#cb38-8" tabindex="-1"></a>  <span class="co"># First summarization to extract sum of counts per point count and number of detections</span></span>
<span id="cb38-9"><a href="hierarchical-model-approach.html#cb38-9" tabindex="-1"></a>  <span class="fu">group_by</span>(site_name, site_id, date, visit_number, common_name, data_type, time_window, detection_time) <span class="sc">|&gt;</span></span>
<span id="cb38-10"><a href="hierarchical-model-approach.html#cb38-10" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">abundance =</span> <span class="fu">sum</span>(abundance, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb38-11"><a href="hierarchical-model-approach.html#cb38-11" tabindex="-1"></a>         <span class="at">acous_detections =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb38-12"><a href="hierarchical-model-approach.html#cb38-12" tabindex="-1"></a>  <span class="co"># Second summarization to count number of detections and extract overall counts</span></span>
<span id="cb38-13"><a href="hierarchical-model-approach.html#cb38-13" tabindex="-1"></a>  <span class="fu">group_by</span>(site_name, site_id, date, visit_number, common_name, time_window) <span class="sc">|&gt;</span></span>
<span id="cb38-14"><a href="hierarchical-model-approach.html#cb38-14" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">counts =</span> <span class="fu">sum</span>(abundance, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb38-15"><a href="hierarchical-model-approach.html#cb38-15" tabindex="-1"></a>         <span class="at">acous_detections =</span> <span class="fu">sum</span>(acous_detections)) <span class="sc">|&gt;</span></span>
<span id="cb38-16"><a href="hierarchical-model-approach.html#cb38-16" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb38-17"><a href="hierarchical-model-approach.html#cb38-17" tabindex="-1"></a></span>
<span id="cb38-18"><a href="hierarchical-model-approach.html#cb38-18" tabindex="-1"></a>acoust_count_summary<span class="sc">$</span>DateTime <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(<span class="fu">paste</span>(acoust_count_summary<span class="sc">$</span>date, acoust_count_summary<span class="sc">$</span>time_window), <span class="at">format =</span> <span class="st">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span>
<span id="cb38-19"><a href="hierarchical-model-approach.html#cb38-19" tabindex="-1"></a></span>
<span id="cb38-20"><a href="hierarchical-model-approach.html#cb38-20" tabindex="-1"></a>acoust_count_summary<span class="sc">$</span>Time_window <span class="ot">&lt;-</span> <span class="fu">floor_date</span>(acoust_count_summary<span class="sc">$</span>DateTime, <span class="st">&quot;10 mins&quot;</span>)</span>
<span id="cb38-21"><a href="hierarchical-model-approach.html#cb38-21" tabindex="-1"></a></span>
<span id="cb38-22"><a href="hierarchical-model-approach.html#cb38-22" tabindex="-1"></a><span class="fu">str</span>(acoust_count_summary)</span></code></pre></div>
<p>And we can generate the figures. This are similar to my previous attempt, but including some days or point counts discarded by Vijay due to species richness.</p>
<div id="figures-of-the-data" class="section level3 hasAnchor" number="7.2.1">
<h3><span class="header-section-number">7.2.1</span> Figures of the data<a href="hierarchical-model-approach.html#figures-of-the-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Time series of the counts</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="hierarchical-model-approach.html#cb39-1" tabindex="-1"></a><span class="fu">ggplot</span>(acoust_count_summary,</span>
<span id="cb39-2"><a href="hierarchical-model-approach.html#cb39-2" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> Time_window, <span class="at">y =</span> counts, <span class="at">color =</span> site_name)) <span class="sc">+</span> </span>
<span id="cb39-3"><a href="hierarchical-model-approach.html#cb39-3" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">0</span>, <span class="at">yend =</span> counts), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb39-4"><a href="hierarchical-model-approach.html#cb39-4" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span> </span>
<span id="cb39-5"><a href="hierarchical-model-approach.html#cb39-5" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>common_name, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb39-6"><a href="hierarchical-model-approach.html#cb39-6" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Time&quot;</span>,</span>
<span id="cb39-7"><a href="hierarchical-model-approach.html#cb39-7" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Number of individuals counted in a 10-minute point count&quot;</span>,</span>
<span id="cb39-8"><a href="hierarchical-model-approach.html#cb39-8" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">&quot;Site&quot;</span>)<span class="sc">+</span></span>
<span id="cb39-9"><a href="hierarchical-model-approach.html#cb39-9" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">met.brewer</span>(<span class="st">&quot;Homer2&quot;</span>, <span class="dv">4</span>))<span class="sc">+</span></span>
<span id="cb39-10"><a href="hierarchical-model-approach.html#cb39-10" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb39-11"><a href="hierarchical-model-approach.html#cb39-11" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb39-12"><a href="hierarchical-model-approach.html#cb39-12" tabindex="-1"></a><span class="co">#ggsave(filename = &quot;figs/counts-by-time-continuous.jpg&quot;, width = 10, height = 10, units = &quot;in&quot;, dpi = 300)</span></span></code></pre></div>
<div class="float">
<img src="figs/counts-by-time-continuous.jpg" alt="Counts during the morning for 22 species" />
<div class="figcaption">Counts during the morning for 22 species</div>
</div>
<p>Time series of acoustic detections</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="hierarchical-model-approach.html#cb40-1" tabindex="-1"></a><span class="fu">ggplot</span>(acoust_count_summary,</span>
<span id="cb40-2"><a href="hierarchical-model-approach.html#cb40-2" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> Time_window, <span class="at">y =</span> acous_detections, <span class="at">color =</span> site_name)) <span class="sc">+</span> </span>
<span id="cb40-3"><a href="hierarchical-model-approach.html#cb40-3" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">0</span>, <span class="at">yend =</span> acous_detections), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb40-4"><a href="hierarchical-model-approach.html#cb40-4" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span> </span>
<span id="cb40-5"><a href="hierarchical-model-approach.html#cb40-5" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>common_name, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="sc">+</span> </span>
<span id="cb40-6"><a href="hierarchical-model-approach.html#cb40-6" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Time&quot;</span>,</span>
<span id="cb40-7"><a href="hierarchical-model-approach.html#cb40-7" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Number of acoustic detections in a 10-minute recording&quot;</span>,</span>
<span id="cb40-8"><a href="hierarchical-model-approach.html#cb40-8" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">&quot;Site&quot;</span>)<span class="sc">+</span></span>
<span id="cb40-9"><a href="hierarchical-model-approach.html#cb40-9" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">met.brewer</span>(<span class="st">&quot;Homer2&quot;</span>, <span class="dv">4</span>))<span class="sc">+</span></span>
<span id="cb40-10"><a href="hierarchical-model-approach.html#cb40-10" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb40-11"><a href="hierarchical-model-approach.html#cb40-11" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb40-12"><a href="hierarchical-model-approach.html#cb40-12" tabindex="-1"></a><span class="co">#ggsave(filename = &quot;figs/acou_det-by-time-continuous.jpg&quot;, width = 10, height = 10, units = &quot;in&quot;, dpi = 300)</span></span></code></pre></div>
<div class="float">
<img src="figs/acou_det-by-time-continuous.jpg" alt="Acoustic detections during the morning for 22 species" />
<div class="figcaption">Acoustic detections during the morning for 22 species</div>
</div>
<p>This summary dataset also allow to see the potential effect of phenology. We can see the two years independently</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="hierarchical-model-approach.html#cb41-1" tabindex="-1"></a>acoust_count_summary <span class="sc">|&gt;</span></span>
<span id="cb41-2"><a href="hierarchical-model-approach.html#cb41-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date)) <span class="sc">|&gt;</span></span>
<span id="cb41-3"><a href="hierarchical-model-approach.html#cb41-3" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2022</span>) <span class="sc">|&gt;</span></span>
<span id="cb41-4"><a href="hierarchical-model-approach.html#cb41-4" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Time_window, <span class="at">y =</span> counts, <span class="at">color =</span> site_name))<span class="sc">+</span></span>
<span id="cb41-5"><a href="hierarchical-model-approach.html#cb41-5" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">0</span>, <span class="at">yend =</span> counts), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb41-6"><a href="hierarchical-model-approach.html#cb41-6" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span> </span>
<span id="cb41-7"><a href="hierarchical-model-approach.html#cb41-7" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>common_name, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb41-8"><a href="hierarchical-model-approach.html#cb41-8" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Date-Time of survey (2022)&quot;</span>,</span>
<span id="cb41-9"><a href="hierarchical-model-approach.html#cb41-9" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Number of individuals counted in a 10-minute point count&quot;</span>,</span>
<span id="cb41-10"><a href="hierarchical-model-approach.html#cb41-10" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">&quot;Site&quot;</span>)<span class="sc">+</span></span>
<span id="cb41-11"><a href="hierarchical-model-approach.html#cb41-11" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">met.brewer</span>(<span class="st">&quot;Homer2&quot;</span>, <span class="dv">4</span>))<span class="sc">+</span></span>
<span id="cb41-12"><a href="hierarchical-model-approach.html#cb41-12" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb41-13"><a href="hierarchical-model-approach.html#cb41-13" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb41-14"><a href="hierarchical-model-approach.html#cb41-14" tabindex="-1"></a><span class="co">#ggsave(filename = &quot;figs/counts-by-date_2022.jpg&quot;, width = 10, height = 10, units = &quot;in&quot;, dpi = 300)</span></span></code></pre></div>
<div class="float">
<img src="figs/counts-by-date_2022.jpg" alt="Counts 2022 - phenology for 22 species" />
<div class="figcaption">Counts 2022 - phenology for 22 species</div>
</div>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="hierarchical-model-approach.html#cb42-1" tabindex="-1"></a>acoust_count_summary <span class="sc">|&gt;</span></span>
<span id="cb42-2"><a href="hierarchical-model-approach.html#cb42-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date)) <span class="sc">|&gt;</span></span>
<span id="cb42-3"><a href="hierarchical-model-approach.html#cb42-3" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2022</span>) <span class="sc">|&gt;</span></span>
<span id="cb42-4"><a href="hierarchical-model-approach.html#cb42-4" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Time_window, <span class="at">y =</span> acous_detections, <span class="at">color =</span> site_name))<span class="sc">+</span></span>
<span id="cb42-5"><a href="hierarchical-model-approach.html#cb42-5" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">0</span>, <span class="at">yend =</span> acous_detections), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb42-6"><a href="hierarchical-model-approach.html#cb42-6" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span> </span>
<span id="cb42-7"><a href="hierarchical-model-approach.html#cb42-7" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>common_name, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="sc">+</span> </span>
<span id="cb42-8"><a href="hierarchical-model-approach.html#cb42-8" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Date-Time of survey (2022)&quot;</span>,</span>
<span id="cb42-9"><a href="hierarchical-model-approach.html#cb42-9" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Number of acoustic detections in a 10-minute recording&quot;</span>,</span>
<span id="cb42-10"><a href="hierarchical-model-approach.html#cb42-10" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">&quot;Site&quot;</span>)<span class="sc">+</span></span>
<span id="cb42-11"><a href="hierarchical-model-approach.html#cb42-11" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">met.brewer</span>(<span class="st">&quot;Homer2&quot;</span>, <span class="dv">4</span>))<span class="sc">+</span></span>
<span id="cb42-12"><a href="hierarchical-model-approach.html#cb42-12" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb42-13"><a href="hierarchical-model-approach.html#cb42-13" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb42-14"><a href="hierarchical-model-approach.html#cb42-14" tabindex="-1"></a><span class="co">#ggsave(filename = &quot;figs/acou_det-by-date_2022.jpg&quot;, width = 10, height = 10, units = &quot;in&quot;, dpi = 300)</span></span></code></pre></div>
<div class="float">
<img src="figs/acou_det-by-date_2022.jpg" alt="Acoustic detections 2022 - phenology for 22 species" />
<div class="figcaption">Acoustic detections 2022 - phenology for 22 species</div>
</div>
<p>And for 2023:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="hierarchical-model-approach.html#cb43-1" tabindex="-1"></a>acoust_count_summary <span class="sc">|&gt;</span></span>
<span id="cb43-2"><a href="hierarchical-model-approach.html#cb43-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date)) <span class="sc">|&gt;</span></span>
<span id="cb43-3"><a href="hierarchical-model-approach.html#cb43-3" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2023</span>) <span class="sc">|&gt;</span></span>
<span id="cb43-4"><a href="hierarchical-model-approach.html#cb43-4" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> DateTime, <span class="at">y =</span> counts, <span class="at">color =</span> site_name))<span class="sc">+</span></span>
<span id="cb43-5"><a href="hierarchical-model-approach.html#cb43-5" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">0</span>, <span class="at">yend =</span> counts), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb43-6"><a href="hierarchical-model-approach.html#cb43-6" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span> </span>
<span id="cb43-7"><a href="hierarchical-model-approach.html#cb43-7" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>common_name, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb43-8"><a href="hierarchical-model-approach.html#cb43-8" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Date of survey (2023)&quot;</span>,</span>
<span id="cb43-9"><a href="hierarchical-model-approach.html#cb43-9" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Number of individuals counted in a 10-minute point count&quot;</span>,</span>
<span id="cb43-10"><a href="hierarchical-model-approach.html#cb43-10" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">&quot;Site&quot;</span>)<span class="sc">+</span></span>
<span id="cb43-11"><a href="hierarchical-model-approach.html#cb43-11" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">met.brewer</span>(<span class="st">&quot;Homer2&quot;</span>, <span class="dv">4</span>))<span class="sc">+</span></span>
<span id="cb43-12"><a href="hierarchical-model-approach.html#cb43-12" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb43-13"><a href="hierarchical-model-approach.html#cb43-13" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb43-14"><a href="hierarchical-model-approach.html#cb43-14" tabindex="-1"></a><span class="co">#ggsave(filename = &quot;figs/counts-by-date_2023.jpg&quot;, width = 10, height = 10, units = &quot;in&quot;, dpi = 300)</span></span></code></pre></div>
<div class="float">
<img src="figs/counts-by-date_2023.jpg" alt="Counts 2023 - phenology for 22 species" />
<div class="figcaption">Counts 2023 - phenology for 22 species</div>
</div>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="hierarchical-model-approach.html#cb44-1" tabindex="-1"></a>acoust_count_summary <span class="sc">|&gt;</span></span>
<span id="cb44-2"><a href="hierarchical-model-approach.html#cb44-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date)) <span class="sc">|&gt;</span></span>
<span id="cb44-3"><a href="hierarchical-model-approach.html#cb44-3" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2023</span>) <span class="sc">|&gt;</span></span>
<span id="cb44-4"><a href="hierarchical-model-approach.html#cb44-4" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> DateTime, <span class="at">y =</span> acous_detections, <span class="at">color =</span> site_name))<span class="sc">+</span></span>
<span id="cb44-5"><a href="hierarchical-model-approach.html#cb44-5" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">0</span>, <span class="at">yend =</span> acous_detections), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb44-6"><a href="hierarchical-model-approach.html#cb44-6" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span> </span>
<span id="cb44-7"><a href="hierarchical-model-approach.html#cb44-7" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>common_name, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="sc">+</span> </span>
<span id="cb44-8"><a href="hierarchical-model-approach.html#cb44-8" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Date of survey (2023)&quot;</span>,</span>
<span id="cb44-9"><a href="hierarchical-model-approach.html#cb44-9" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Number of acoustic detections in a 10-minute recording&quot;</span>,</span>
<span id="cb44-10"><a href="hierarchical-model-approach.html#cb44-10" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">&quot;Site&quot;</span>)<span class="sc">+</span></span>
<span id="cb44-11"><a href="hierarchical-model-approach.html#cb44-11" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">met.brewer</span>(<span class="st">&quot;Homer2&quot;</span>, <span class="dv">4</span>))<span class="sc">+</span></span>
<span id="cb44-12"><a href="hierarchical-model-approach.html#cb44-12" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb44-13"><a href="hierarchical-model-approach.html#cb44-13" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb44-14"><a href="hierarchical-model-approach.html#cb44-14" tabindex="-1"></a><span class="co">#ggsave(filename = &quot;figs/acou_det-by-date_2023.jpg&quot;, width = 10, height = 10, units = &quot;in&quot;, dpi = 300)</span></span></code></pre></div>
<div class="float">
<img src="figs/acou_det-by-date_2023.jpg" alt="Acoustic detections 2023 - phenology for 22 species" />
<div class="figcaption">Acoustic detections 2023 - phenology for 22 species</div>
</div>
<p>These figures serve to see that the date of visit have a more clear effect in acoustic detections than on counts. We can incorporate these covariates in a hierarchical model.</p>
<p>These figures also allow to estimate the variance-to-mean ratio (VMR) of our two data sources (counts and acoustic detections) to select a family distribution accordingly. Recall a simple, clear table of VMR values:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="hierarchical-model-approach.html#cb45-1" tabindex="-1"></a>VMR_table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb45-2"><a href="hierarchical-model-approach.html#cb45-2" tabindex="-1"></a>  <span class="at">Distribution =</span> <span class="fu">c</span>(<span class="st">&quot;Constant random variable&quot;</span>, <span class="st">&quot;Binomial&quot;</span>,<span class="st">&quot;Poisson&quot;</span>, <span class="st">&quot;Negative binomial&quot;</span>),</span>
<span id="cb45-3"><a href="hierarchical-model-approach.html#cb45-3" tabindex="-1"></a>  <span class="at">VMR =</span> <span class="fu">c</span>(<span class="st">&quot;VMR = 0&quot;</span>, <span class="st">&quot;0&lt;VMR&lt;1&quot;</span>, <span class="st">&quot;VMR = 1&quot;</span>, <span class="st">&quot;VMR&gt;1&quot;</span>)</span>
<span id="cb45-4"><a href="hierarchical-model-approach.html#cb45-4" tabindex="-1"></a>)</span>
<span id="cb45-5"><a href="hierarchical-model-approach.html#cb45-5" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(VMR_table)</span></code></pre></div>
<p>So, estimating these VMR per species:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="hierarchical-model-approach.html#cb46-1" tabindex="-1"></a>acoust_count_summary <span class="sc">|&gt;</span></span>
<span id="cb46-2"><a href="hierarchical-model-approach.html#cb46-2" tabindex="-1"></a>  <span class="fu">group_by</span>(common_name) <span class="sc">|&gt;</span></span>
<span id="cb46-3"><a href="hierarchical-model-approach.html#cb46-3" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">meanCounts =</span> <span class="fu">mean</span>(counts),</span>
<span id="cb46-4"><a href="hierarchical-model-approach.html#cb46-4" tabindex="-1"></a>            <span class="at">varCounts =</span> <span class="fu">var</span>(counts), </span>
<span id="cb46-5"><a href="hierarchical-model-approach.html#cb46-5" tabindex="-1"></a>            <span class="at">VMR_counts =</span> varCounts<span class="sc">/</span>meanCounts,</span>
<span id="cb46-6"><a href="hierarchical-model-approach.html#cb46-6" tabindex="-1"></a>            <span class="at">meanAcouDet =</span> <span class="fu">mean</span>(acous_detections),</span>
<span id="cb46-7"><a href="hierarchical-model-approach.html#cb46-7" tabindex="-1"></a>            <span class="at">varAcouDet =</span> <span class="fu">var</span>(acous_detections), </span>
<span id="cb46-8"><a href="hierarchical-model-approach.html#cb46-8" tabindex="-1"></a>            <span class="at">VMR_AcouDet =</span> varAcouDet<span class="sc">/</span>meanAcouDet) <span class="sc">|&gt;</span> <span class="co">#summary()</span></span>
<span id="cb46-9"><a href="hierarchical-model-approach.html#cb46-9" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="co"># to see all the table</span></span></code></pre></div>
<p>We can see that VMR_counts is between 0 and 1, while VMR_AcousticDetection &gt; 1. These ranges suggest using a Binomial and a Negative binomial distributions, respectively, in the observation process.</p>
</div>
</div>
<div id="hierarchical-model-for-counts-with-two-observation-processes" class="section level2 hasAnchor" number="7.3">
<h2><span class="header-section-number">7.3</span> Hierarchical model for counts with two observation processes<a href="hierarchical-model-approach.html#hierarchical-model-for-counts-with-two-observation-processes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="state-process-for-morning-expected-counts" class="section level3 hasAnchor" number="7.3.1">
<h3><span class="header-section-number">7.3.1</span> State process for morning expected counts<a href="hierarchical-model-approach.html#state-process-for-morning-expected-counts" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Assuming that every morning of sampling we find a latent number of individuals in each site (including several point counts) that fluctuates around a mean stationary number, we can see some similarities with a Stochastic Gompertz State Space population dynamics model, which in continuous time follows a Gaussian (Ornstein-Uhlenbeck, OU) diffusion dynamic.</p>
<p>Let’s model the latent process of log-counts <span class="math inline">\(X_{i,t} = \ln(C_{i,t})\)</span> for species <span class="math inline">\(i\)</span> in time <span class="math inline">\(t\)</span> (sampling point count) in a site <span class="math inline">\(m\)</span>. We can simplify this (for now) by only working in a site (<span class="math inline">\(m = 1\)</span>; Marsh-Billings-Rockefeller NHP) and a single species example (<span class="math inline">\(i = 1\)</span>; Ovenbird - OVEN). On the logarithmic scale, the process becomes linear and follows an autoregressive model of order 1 (note we are not including the index <span class="math inline">\(m\)</span> nor <span class="math inline">\(i\)</span> for now):</p>
<p><span class="math display">\[
X_{t+1} = a + c * X_{t} + \epsilon_{t}; ~ \epsilon \sim \text{Normal}(0,\sigma^2)
\]</span>
where <span class="math inline">\(a\)</span> control the drift (equivalent to the initial condition at <span class="math inline">\(t=1\)</span>, and then the maximum growth rate in a population model), <span class="math inline">\(c\)</span> controls the mean-reverting dynamic (such as the strength of density dependence, <span class="math inline">\(c = 1 + b\)</span> in a population model), and <span class="math inline">\(\epsilon_{t}\)</span> captures stochasticity in the process, distributed as a normal random variable with some noise of the process <span class="math inline">\(\sigma^2\)</span>. In the long-run, we can estimate the mean of the log-counts as a function of the control drift and mean-reverting dynamic:</p>
<p><span class="math display">\[
\text{E}[X_{\infty}] = \frac{a}{1-c}
\]</span></p>
<p>Also the variance of the log-counts is given by the ratio of variance in stochasticity and the square of the mean-reverting dynamic:</p>
<p><span class="math display">\[
\text{Var}[X_{\infty}] = \frac{\sigma^2}{1-c^2}
\]</span></p>
<p>However, how to deal with Jansen’s inequality?!</p>
<p><span class="math display">\[
e^{(\text{E}[X_\infty])} \leq \text{E}[e^{(X_\infty)}]
\]</span></p>
<p>We can estimate the long-run mean count value on the original scale by adding half of the variance, which is our expected counts per species <span class="math inline">\(i\)</span>:</p>
<p><span class="math display">\[
\text{E}[C_{\infty}] = e^{(\text{E}[X_{\infty}] + (0.5 \times \text{Var}[X_{\infty}]))}
\]</span></p>
</div>
<div id="observation-process-for-morning-point-counts" class="section level3 hasAnchor" number="7.3.2">
<h3><span class="header-section-number">7.3.2</span> Observation process for morning point counts<a href="hierarchical-model-approach.html#observation-process-for-morning-point-counts" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The VMR_counts revealed underdispersion, so we can us a Binomial distribution for this observation process:</p>
<p><span class="math display">\[
Y_{t}^{Counts} | C_{t} \sim \text{Binomial}(\lambda_{t},~\tau), ~ \lambda_{t} = e^{X_{t}} = C_{t}
\]</span>
where <span class="math inline">\(Y_{t}^{counts}\)</span> is the observed counts from point counts sampling, linked to the latent (unobserved) counts <span class="math inline">\(C_{t}\)</span>, assuming that counts are noisy realizations of the true abundance under a binomial distribution with expected “success” counts of <span class="math inline">\(\lambda_{t}\)</span> and detection probability <span class="math inline">\(\tau\)</span>.</p>
</div>
<div id="observation-process-for-morning-acoustic-detections" class="section level3 hasAnchor" number="7.3.3">
<h3><span class="header-section-number">7.3.3</span> Observation process for morning acoustic detections<a href="hierarchical-model-approach.html#observation-process-for-morning-acoustic-detections" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The VMR_AcousticDetection revealed overdispersion, so we can use a Negative Binomial distribution for this observation process:</p>
<p><span class="math display">\[
Y_{t}^{AcoustDet}|C_t \sim \text{Negative Binomial}(p_{t}, r)
\]</span>
where <span class="math inline">\(Y_{t}^{AcoustDet}\)</span> is the observed acoustic detections from sampling point (that overlap with point counts), <span class="math inline">\(p_{t} = \frac{r}{r+\lambda_t}\)</span> represents the success parameter, being a ratio of the (over)dispersion parameter <span class="math inline">\(r\)</span> and the sum of the overdispersion parameter and the mean expected counts <span class="math inline">\(\lambda_t = e^{X_t} = C_t\)</span>. Given that the number of acoustic detection counts does not have a perfect 1:1 relationship with expected counts, we can formulate a log-linear relationship for <span class="math inline">\(\lambda_t\)</span>:</p>
<p><span class="math display">\[
\log(\lambda_{t}) = \alpha + \gamma X_{t}
\]</span>
where <span class="math inline">\(\alpha\)</span> is a species-level intercept and <span class="math inline">\(\gamma\)</span> is the scaling parameter with the latent log-abundance <span class="math inline">\(X_{t}\)</span>.</p>
</div>
<div id="coding-observation-point-counts" class="section level3 hasAnchor" number="7.3.4">
<h3><span class="header-section-number">7.3.4</span> Coding Observation point counts<a href="hierarchical-model-approach.html#coding-observation-point-counts" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Preparing data for data cloning</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="hierarchical-model-approach.html#cb47-1" tabindex="-1"></a></span>
<span id="cb47-2"><a href="hierarchical-model-approach.html#cb47-2" tabindex="-1"></a>acoust_count_df <span class="ot">&lt;-</span> acoust_count_summary <span class="sc">|&gt;</span></span>
<span id="cb47-3"><a href="hierarchical-model-approach.html#cb47-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Time_w_alone =</span> <span class="fu">format</span>(<span class="fu">as.POSIXct</span>(Time_window, <span class="at">format =</span> <span class="st">&quot;%Y-%m-%d %H:%M:%S&quot;</span>), <span class="st">&quot;%H:%M&quot;</span>), </span>
<span id="cb47-4"><a href="hierarchical-model-approach.html#cb47-4" tabindex="-1"></a>         <span class="at">counts =</span> counts<span class="sc">+</span><span class="dv">1</span>,</span>
<span id="cb47-5"><a href="hierarchical-model-approach.html#cb47-5" tabindex="-1"></a>         <span class="at">acous_detections =</span> acous_detections<span class="sc">+</span><span class="dv">1</span>,</span>
<span id="cb47-6"><a href="hierarchical-model-approach.html#cb47-6" tabindex="-1"></a>         <span class="at">year =</span> <span class="fu">year</span>(date), </span>
<span id="cb47-7"><a href="hierarchical-model-approach.html#cb47-7" tabindex="-1"></a>         ) <span class="sc">|&gt;</span></span>
<span id="cb47-8"><a href="hierarchical-model-approach.html#cb47-8" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2022</span>) <span class="sc">|&gt;</span></span>
<span id="cb47-9"><a href="hierarchical-model-approach.html#cb47-9" tabindex="-1"></a>  <span class="fu">arrange</span>(Time_window)</span>
<span id="cb47-10"><a href="hierarchical-model-approach.html#cb47-10" tabindex="-1"></a></span>
<span id="cb47-11"><a href="hierarchical-model-approach.html#cb47-11" tabindex="-1"></a><span class="co"># generate sequence of potential point counts</span></span>
<span id="cb47-12"><a href="hierarchical-model-approach.html#cb47-12" tabindex="-1"></a>seq_df <span class="ot">&lt;-</span> acoust_count_df <span class="sc">|&gt;</span></span>
<span id="cb47-13"><a href="hierarchical-model-approach.html#cb47-13" tabindex="-1"></a>  <span class="fu">distinct</span>(date) <span class="sc">|&gt;</span>   <span class="co"># keep only unique sampled dates</span></span>
<span id="cb47-14"><a href="hierarchical-model-approach.html#cb47-14" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">seq =</span> <span class="fu">map</span>(date, <span class="sc">~</span> <span class="fu">seq</span>(</span>
<span id="cb47-15"><a href="hierarchical-model-approach.html#cb47-15" tabindex="-1"></a>    <span class="at">from =</span> <span class="fu">as.POSIXct</span>(<span class="fu">paste</span>(.x, <span class="st">&quot;05:00:00&quot;</span>)),</span>
<span id="cb47-16"><a href="hierarchical-model-approach.html#cb47-16" tabindex="-1"></a>    <span class="at">to   =</span> <span class="fu">as.POSIXct</span>(<span class="fu">paste</span>(.x, <span class="st">&quot;10:00:00&quot;</span>)),</span>
<span id="cb47-17"><a href="hierarchical-model-approach.html#cb47-17" tabindex="-1"></a>    <span class="at">by   =</span> <span class="st">&quot;10 min&quot;</span></span>
<span id="cb47-18"><a href="hierarchical-model-approach.html#cb47-18" tabindex="-1"></a>  ))) <span class="sc">|&gt;</span></span>
<span id="cb47-19"><a href="hierarchical-model-approach.html#cb47-19" tabindex="-1"></a>  <span class="fu">unnest</span>(seq) <span class="sc">|&gt;</span></span>
<span id="cb47-20"><a href="hierarchical-model-approach.html#cb47-20" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Time_window =</span> seq,</span>
<span id="cb47-21"><a href="hierarchical-model-approach.html#cb47-21" tabindex="-1"></a>         <span class="at">Time_w_alone =</span> <span class="fu">format</span>(seq, <span class="st">&quot;%H:%M&quot;</span>))</span>
<span id="cb47-22"><a href="hierarchical-model-approach.html#cb47-22" tabindex="-1"></a></span>
<span id="cb47-23"><a href="hierarchical-model-approach.html#cb47-23" tabindex="-1"></a>final_df <span class="ot">&lt;-</span> seq_df <span class="sc">|&gt;</span></span>
<span id="cb47-24"><a href="hierarchical-model-approach.html#cb47-24" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(date, Time_w_alone)) <span class="sc">|&gt;</span></span>
<span id="cb47-25"><a href="hierarchical-model-approach.html#cb47-25" tabindex="-1"></a>  <span class="fu">left_join</span>(acoust_count_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;Time_w_alone&quot;</span>)) </span>
<span id="cb47-26"><a href="hierarchical-model-approach.html#cb47-26" tabindex="-1"></a></span>
<span id="cb47-27"><a href="hierarchical-model-approach.html#cb47-27" tabindex="-1"></a>final_df<span class="sc">$</span>DateTime <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(<span class="fu">paste</span>(final_df<span class="sc">$</span>date, final_df<span class="sc">$</span>Time_w_alone), <span class="at">format =</span> <span class="st">&quot;%Y-%m-%d %H:%M&quot;</span>)</span>
<span id="cb47-28"><a href="hierarchical-model-approach.html#cb47-28" tabindex="-1"></a></span>
<span id="cb47-29"><a href="hierarchical-model-approach.html#cb47-29" tabindex="-1"></a>final_df<span class="sc">$</span>time_id <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">factor</span>(final_df<span class="sc">$</span>DateTime))</span></code></pre></div>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="hierarchical-model-approach.html#cb48-1" tabindex="-1"></a>StochGSS.dc <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb48-2"><a href="hierarchical-model-approach.html#cb48-2" tabindex="-1"></a>  </span>
<span id="cb48-3"><a href="hierarchical-model-approach.html#cb48-3" tabindex="-1"></a>  <span class="co"># Priors on model parameters. Priors are DC1 in Lele et al (2007)</span></span>
<span id="cb48-4"><a href="hierarchical-model-approach.html#cb48-4" tabindex="-1"></a>  a1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>);        <span class="co"># constant, equivalent to the population growth rate. </span></span>
<span id="cb48-5"><a href="hierarchical-model-approach.html#cb48-5" tabindex="-1"></a>  c1 <span class="sc">~</span> <span class="fu">dunif</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>);       <span class="co"># constant, the density dependence parameter. </span></span>
<span id="cb48-6"><a href="hierarchical-model-approach.html#cb48-6" tabindex="-1"></a>  sig1 <span class="sc">~</span> <span class="fu">dlnorm</span>(<span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">10</span>); <span class="co">#variance parameter of stochastic  environment (process noise) in the system</span></span>
<span id="cb48-7"><a href="hierarchical-model-approach.html#cb48-7" tabindex="-1"></a>  stovar1 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">pow</span>(sig1,<span class="dv">2</span>)</span>
<span id="cb48-8"><a href="hierarchical-model-approach.html#cb48-8" tabindex="-1"></a>  tau1 <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>,<span class="dv">1</span>); <span class="co"># detection probability in Binomial distribution</span></span>
<span id="cb48-9"><a href="hierarchical-model-approach.html#cb48-9" tabindex="-1"></a>  </span>
<span id="cb48-10"><a href="hierarchical-model-approach.html#cb48-10" tabindex="-1"></a>  <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb48-11"><a href="hierarchical-model-approach.html#cb48-11" tabindex="-1"></a>    <span class="co"># Simulate trajectory that depends on the previous</span></span>
<span id="cb48-12"><a href="hierarchical-model-approach.html#cb48-12" tabindex="-1"></a>    mean_X1[<span class="dv">1</span>,k] <span class="ot">&lt;-</span> a1<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>c1) <span class="co"># Expected value of the first realization of the process</span></span>
<span id="cb48-13"><a href="hierarchical-model-approach.html#cb48-13" tabindex="-1"></a>    <span class="co"># this is drawn from the stationary distribution of the process</span></span>
<span id="cb48-14"><a href="hierarchical-model-approach.html#cb48-14" tabindex="-1"></a>    <span class="co"># Equation 14 (main text) and  A.4 in Appendix of Dennis et al 2006</span></span>
<span id="cb48-15"><a href="hierarchical-model-approach.html#cb48-15" tabindex="-1"></a>    Varno1[k] <span class="ot">&lt;-</span> <span class="fu">pow</span>(sig1,<span class="dv">2</span>)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">pow</span>(c1,<span class="dv">2</span>)) <span class="co">#. Equation A.5 in Appendix of Dennis et al 2006</span></span>
<span id="cb48-16"><a href="hierarchical-model-approach.html#cb48-16" tabindex="-1"></a>    </span>
<span id="cb48-17"><a href="hierarchical-model-approach.html#cb48-17" tabindex="-1"></a>    <span class="co"># Updating the state: Stochastic process for all time steps</span></span>
<span id="cb48-18"><a href="hierarchical-model-approach.html#cb48-18" tabindex="-1"></a>    X1[<span class="dv">1</span>,k]<span class="sc">~</span><span class="fu">dnorm</span>(mean_X1[<span class="dv">1</span>,k], <span class="dv">1</span><span class="sc">/</span>Varno1[k]); <span class="co">#first estimation of population</span></span>
<span id="cb48-19"><a href="hierarchical-model-approach.html#cb48-19" tabindex="-1"></a>    </span>
<span id="cb48-20"><a href="hierarchical-model-approach.html#cb48-20" tabindex="-1"></a>    <span class="co">#iteration of the GSS model in the data</span></span>
<span id="cb48-21"><a href="hierarchical-model-approach.html#cb48-21" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>qp1) {</span>
<span id="cb48-22"><a href="hierarchical-model-approach.html#cb48-22" tabindex="-1"></a>      mean_X1[t,k] <span class="ot">&lt;-</span> a1 <span class="sc">+</span> c1 <span class="sc">*</span> X1[(t <span class="sc">-</span> <span class="dv">1</span>),k]</span>
<span id="cb48-23"><a href="hierarchical-model-approach.html#cb48-23" tabindex="-1"></a>      X1[t,k] <span class="sc">~</span> <span class="fu">dnorm</span>(mean_X1[t,k], stovar1) <span class="co"># Et is included here since a+cX(t-1) + Et ~ Normal(a+cX(t-1),sigma^2)</span></span>
<span id="cb48-24"><a href="hierarchical-model-approach.html#cb48-24" tabindex="-1"></a>    }</span>
<span id="cb48-25"><a href="hierarchical-model-approach.html#cb48-25" tabindex="-1"></a>    </span>
<span id="cb48-26"><a href="hierarchical-model-approach.html#cb48-26" tabindex="-1"></a>    <span class="co"># Updating the observations, from the counts under Binomial observation error</span></span>
<span id="cb48-27"><a href="hierarchical-model-approach.html#cb48-27" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>qp1) {</span>
<span id="cb48-28"><a href="hierarchical-model-approach.html#cb48-28" tabindex="-1"></a>      N1[t,k] <span class="sc">~</span> <span class="fu">dpois</span>(<span class="fu">exp</span>(X1[t,k]))   <span class="co"># trick to convert continuous exp(X1) to integer counts as trials</span></span>
<span id="cb48-29"><a href="hierarchical-model-approach.html#cb48-29" tabindex="-1"></a>      Y1[t,k] <span class="sc">~</span> <span class="fu">dbin</span>(tau1, N1[t,k])   <span class="co"># </span></span>
<span id="cb48-30"><a href="hierarchical-model-approach.html#cb48-30" tabindex="-1"></a>    }</span>
<span id="cb48-31"><a href="hierarchical-model-approach.html#cb48-31" tabindex="-1"></a>  }</span>
<span id="cb48-32"><a href="hierarchical-model-approach.html#cb48-32" tabindex="-1"></a>}</span></code></pre></div>
<p>For this model, we will need some initial values of the parameters, and given that there could be many <code>NA</code> a wrap to provide those initial guess values.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="hierarchical-model-approach.html#cb49-1" tabindex="-1"></a>guess.calc <span class="ot">&lt;-</span> <span class="cf">function</span>(Yobs,Tvec){</span>
<span id="cb49-2"><a href="hierarchical-model-approach.html#cb49-2" tabindex="-1"></a>  </span>
<span id="cb49-3"><a href="hierarchical-model-approach.html#cb49-3" tabindex="-1"></a>  T.t <span class="ot">&lt;-</span>Tvec<span class="sc">-</span>Tvec[<span class="dv">1</span>]; <span class="co">#  For calculations, time starts at zero.</span></span>
<span id="cb49-4"><a href="hierarchical-model-approach.html#cb49-4" tabindex="-1"></a>  q <span class="ot">&lt;-</span> <span class="fu">length</span>(Yobs)<span class="sc">-</span><span class="dv">1</span>;      <span class="co">#  Number of time series transitions, q.</span></span>
<span id="cb49-5"><a href="hierarchical-model-approach.html#cb49-5" tabindex="-1"></a>  qp1 <span class="ot">&lt;-</span> q<span class="sc">+</span><span class="dv">1</span>;              <span class="co">#  q+1 gets used a lot, too.</span></span>
<span id="cb49-6"><a href="hierarchical-model-approach.html#cb49-6" tabindex="-1"></a>  S.t <span class="ot">&lt;-</span> T.t[<span class="dv">2</span><span class="sc">:</span>qp1]<span class="sc">-</span>T.t[<span class="dv">1</span><span class="sc">:</span>q];  <span class="co">#  Time intervals.</span></span>
<span id="cb49-7"><a href="hierarchical-model-approach.html#cb49-7" tabindex="-1"></a>  Ybar <span class="ot">&lt;-</span> <span class="fu">mean</span>(Yobs);</span>
<span id="cb49-8"><a href="hierarchical-model-approach.html#cb49-8" tabindex="-1"></a>  Yvar <span class="ot">&lt;-</span> <span class="fu">sum</span>((Yobs<span class="sc">-</span>Ybar)<span class="sc">*</span>(Yobs<span class="sc">-</span>Ybar))<span class="sc">/</span>q;</span>
<span id="cb49-9"><a href="hierarchical-model-approach.html#cb49-9" tabindex="-1"></a>  mu1 <span class="ot">&lt;-</span> Ybar;</span>
<span id="cb49-10"><a href="hierarchical-model-approach.html#cb49-10" tabindex="-1"></a>  </span>
<span id="cb49-11"><a href="hierarchical-model-approach.html#cb49-11" tabindex="-1"></a>  <span class="co"># Kludge an initial value for theta based on mean of Y(t+s) given Y(t).</span></span>
<span id="cb49-12"><a href="hierarchical-model-approach.html#cb49-12" tabindex="-1"></a>  th1<span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">mean</span>(<span class="fu">log</span>(<span class="fu">abs</span>((Yobs[<span class="dv">2</span><span class="sc">:</span>qp1]<span class="sc">-</span>mu1)<span class="sc">/</span>(Yobs[<span class="dv">1</span><span class="sc">:</span>q]<span class="sc">-</span>mu1)))<span class="sc">/</span>S.t);            </span>
<span id="cb49-13"><a href="hierarchical-model-approach.html#cb49-13" tabindex="-1"></a>  bsq1<span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>th1<span class="sc">*</span>Yvar<span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>th1);         <span class="co"># Moment estimate using stationary</span></span>
<span id="cb49-14"><a href="hierarchical-model-approach.html#cb49-14" tabindex="-1"></a>  tsq1<span class="ot">&lt;-</span> bsq1;                         <span class="co">#   variance, with betasq=tausq.</span></span>
<span id="cb49-15"><a href="hierarchical-model-approach.html#cb49-15" tabindex="-1"></a>  </span>
<span id="cb49-16"><a href="hierarchical-model-approach.html#cb49-16" tabindex="-1"></a>  <span class="co">#three 0&#39;s </span></span>
<span id="cb49-17"><a href="hierarchical-model-approach.html#cb49-17" tabindex="-1"></a>  three0s <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">c</span>(th1,bsq1,tsq1))</span>
<span id="cb49-18"><a href="hierarchical-model-approach.html#cb49-18" tabindex="-1"></a>  <span class="cf">if</span>(three0s<span class="sc">==</span><span class="dv">0</span><span class="sc">|</span><span class="fu">is.na</span>(three0s)){th1 <span class="ot">&lt;-</span> <span class="fl">0.5</span>;bsq1 <span class="ot">&lt;-</span> <span class="fl">0.09</span>; tsq1 <span class="ot">&lt;-</span> <span class="fl">0.23</span>;}</span>
<span id="cb49-19"><a href="hierarchical-model-approach.html#cb49-19" tabindex="-1"></a>  </span>
<span id="cb49-20"><a href="hierarchical-model-approach.html#cb49-20" tabindex="-1"></a>  </span>
<span id="cb49-21"><a href="hierarchical-model-approach.html#cb49-21" tabindex="-1"></a>  out1 <span class="ot">&lt;-</span> <span class="fu">c</span>(th1,bsq1,tsq1);</span>
<span id="cb49-22"><a href="hierarchical-model-approach.html#cb49-22" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">sum</span>(out1<span class="sc">&lt;</span><span class="fl">1e-7</span>)<span class="sc">&gt;=</span><span class="dv">1</span>){out1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">0.09</span>,<span class="fl">0.23</span>)}</span>
<span id="cb49-23"><a href="hierarchical-model-approach.html#cb49-23" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">c</span>(mu1,out1);</span>
<span id="cb49-24"><a href="hierarchical-model-approach.html#cb49-24" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">abs</span>(out))</span>
<span id="cb49-25"><a href="hierarchical-model-approach.html#cb49-25" tabindex="-1"></a>  </span>
<span id="cb49-26"><a href="hierarchical-model-approach.html#cb49-26" tabindex="-1"></a>}</span>
<span id="cb49-27"><a href="hierarchical-model-approach.html#cb49-27" tabindex="-1"></a></span>
<span id="cb49-28"><a href="hierarchical-model-approach.html#cb49-28" tabindex="-1"></a>guess.calc2<span class="fl">.0</span><span class="ot">&lt;-</span> <span class="cf">function</span>(TimeAndNs){</span>
<span id="cb49-29"><a href="hierarchical-model-approach.html#cb49-29" tabindex="-1"></a>  </span>
<span id="cb49-30"><a href="hierarchical-model-approach.html#cb49-30" tabindex="-1"></a>  newmat <span class="ot">&lt;-</span> TimeAndNs </span>
<span id="cb49-31"><a href="hierarchical-model-approach.html#cb49-31" tabindex="-1"></a>  isnas <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(TimeAndNs))</span>
<span id="cb49-32"><a href="hierarchical-model-approach.html#cb49-32" tabindex="-1"></a>  </span>
<span id="cb49-33"><a href="hierarchical-model-approach.html#cb49-33" tabindex="-1"></a>  <span class="cf">if</span>(isnas <span class="sc">&gt;=</span> <span class="dv">1</span>){</span>
<span id="cb49-34"><a href="hierarchical-model-approach.html#cb49-34" tabindex="-1"></a>    </span>
<span id="cb49-35"><a href="hierarchical-model-approach.html#cb49-35" tabindex="-1"></a>    isnaind <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(TimeAndNs[,<span class="dv">2</span>]), <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb49-36"><a href="hierarchical-model-approach.html#cb49-36" tabindex="-1"></a>    newmat <span class="ot">&lt;-</span> TimeAndNs[<span class="sc">-</span>isnaind,]</span>
<span id="cb49-37"><a href="hierarchical-model-approach.html#cb49-37" tabindex="-1"></a>    newmat[,<span class="dv">1</span>] <span class="ot">&lt;-</span> newmat[,<span class="dv">1</span>] <span class="sc">-</span> newmat[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb49-38"><a href="hierarchical-model-approach.html#cb49-38" tabindex="-1"></a>    </span>
<span id="cb49-39"><a href="hierarchical-model-approach.html#cb49-39" tabindex="-1"></a>  }</span>
<span id="cb49-40"><a href="hierarchical-model-approach.html#cb49-40" tabindex="-1"></a>  </span>
<span id="cb49-41"><a href="hierarchical-model-approach.html#cb49-41" tabindex="-1"></a>  init.guess <span class="ot">&lt;-</span> <span class="fu">guess.calc</span>(<span class="at">Yobs =</span> <span class="fu">log</span>(newmat[,<span class="dv">2</span>]), <span class="at">Tvec=</span>newmat[,<span class="dv">1</span>])</span>
<span id="cb49-42"><a href="hierarchical-model-approach.html#cb49-42" tabindex="-1"></a>  </span>
<span id="cb49-43"><a href="hierarchical-model-approach.html#cb49-43" tabindex="-1"></a>  mu1  <span class="ot">&lt;-</span> init.guess[<span class="dv">1</span>]</span>
<span id="cb49-44"><a href="hierarchical-model-approach.html#cb49-44" tabindex="-1"></a>  th1  <span class="ot">&lt;-</span> init.guess[<span class="dv">2</span>]</span>
<span id="cb49-45"><a href="hierarchical-model-approach.html#cb49-45" tabindex="-1"></a>  bsq1 <span class="ot">&lt;-</span> init.guess[<span class="dv">3</span>]</span>
<span id="cb49-46"><a href="hierarchical-model-approach.html#cb49-46" tabindex="-1"></a>  sigsq1<span class="ot">&lt;-</span> ((<span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>th1))<span class="sc">*</span>bsq1)<span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>th1)</span>
<span id="cb49-47"><a href="hierarchical-model-approach.html#cb49-47" tabindex="-1"></a>  </span>
<span id="cb49-48"><a href="hierarchical-model-approach.html#cb49-48" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">mu=</span>mu1, <span class="at">theta=</span>th1, <span class="at">sigmasq =</span> sigsq1)</span>
<span id="cb49-49"><a href="hierarchical-model-approach.html#cb49-49" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb49-50"><a href="hierarchical-model-approach.html#cb49-50" tabindex="-1"></a>}</span></code></pre></div>
<p>And we have to bundle the data for Data cloning. Let’s fit the first species in the taxa with higher data (Ovenbird in Marsh-Billings-Rockefeller NHP) as a test.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="hierarchical-model-approach.html#cb50-1" tabindex="-1"></a>ts<span class="fl">.4</span>guess  <span class="ot">&lt;-</span>  final_df<span class="sc">$</span>counts</span>
<span id="cb50-2"><a href="hierarchical-model-approach.html#cb50-2" tabindex="-1"></a>tvec4guess  <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ts<span class="fl">.4</span>guess)</span>
<span id="cb50-3"><a href="hierarchical-model-approach.html#cb50-3" tabindex="-1"></a>onets4guess <span class="ot">&lt;-</span> <span class="fu">cbind</span>(tvec4guess, ts<span class="fl">.4</span>guess)</span>
<span id="cb50-4"><a href="hierarchical-model-approach.html#cb50-4" tabindex="-1"></a>naive.guess <span class="ot">&lt;-</span> <span class="fu">guess.calc2.0</span>(<span class="at">TimeAndNs =</span> onets4guess)</span>
<span id="cb50-5"><a href="hierarchical-model-approach.html#cb50-5" tabindex="-1"></a></span>
<span id="cb50-6"><a href="hierarchical-model-approach.html#cb50-6" tabindex="-1"></a>datalistGSS.dc <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">K =</span> <span class="dv">1</span>,</span>
<span id="cb50-7"><a href="hierarchical-model-approach.html#cb50-7" tabindex="-1"></a>                       <span class="at">qp1 =</span> <span class="fu">length</span>(ts<span class="fl">.4</span>guess),</span>
<span id="cb50-8"><a href="hierarchical-model-approach.html#cb50-8" tabindex="-1"></a>                       <span class="at">Y1 =</span> <span class="fu">dcdim</span>(<span class="fu">array</span>(ts<span class="fl">.4</span>guess,</span>
<span id="cb50-9"><a href="hierarchical-model-approach.html#cb50-9" tabindex="-1"></a>                                        <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">length</span>(ts<span class="fl">.4</span>guess),<span class="dv">1</span>)))) </span>
<span id="cb50-10"><a href="hierarchical-model-approach.html#cb50-10" tabindex="-1"></a></span>
<span id="cb50-11"><a href="hierarchical-model-approach.html#cb50-11" tabindex="-1"></a>dcrun.GSS <span class="ot">&lt;-</span> <span class="fu">dc.fit</span>(<span class="at">data =</span> datalistGSS.dc,</span>
<span id="cb50-12"><a href="hierarchical-model-approach.html#cb50-12" tabindex="-1"></a>                    <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;a1&quot;</span>, <span class="st">&quot;c1&quot;</span>, <span class="st">&quot;sig1&quot;</span>, <span class="st">&quot;tau1&quot;</span>), </span>
<span id="cb50-13"><a href="hierarchical-model-approach.html#cb50-13" tabindex="-1"></a>                    <span class="at">model =</span> StochGSS.dc, </span>
<span id="cb50-14"><a href="hierarchical-model-approach.html#cb50-14" tabindex="-1"></a>                    <span class="at">n.clones =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">20</span>),</span>
<span id="cb50-15"><a href="hierarchical-model-approach.html#cb50-15" tabindex="-1"></a>                    <span class="at">multiply =</span> <span class="st">&quot;K&quot;</span>,</span>
<span id="cb50-16"><a href="hierarchical-model-approach.html#cb50-16" tabindex="-1"></a>                    <span class="at">unchanged =</span> <span class="st">&quot;qp1&quot;</span>,</span>
<span id="cb50-17"><a href="hierarchical-model-approach.html#cb50-17" tabindex="-1"></a>                    <span class="at">n.chains =</span> <span class="dv">3</span>,</span>
<span id="cb50-18"><a href="hierarchical-model-approach.html#cb50-18" tabindex="-1"></a>                    <span class="at">n.adapt =</span> <span class="dv">5000</span>,</span>
<span id="cb50-19"><a href="hierarchical-model-approach.html#cb50-19" tabindex="-1"></a>                    <span class="at">n.update =</span> <span class="dv">100</span>,</span>
<span id="cb50-20"><a href="hierarchical-model-approach.html#cb50-20" tabindex="-1"></a>                    <span class="at">thin =</span> <span class="dv">20</span>,</span>
<span id="cb50-21"><a href="hierarchical-model-approach.html#cb50-21" tabindex="-1"></a>                    <span class="at">n.iter =</span> <span class="dv">20000</span>)</span>
<span id="cb50-22"><a href="hierarchical-model-approach.html#cb50-22" tabindex="-1"></a></span>
<span id="cb50-23"><a href="hierarchical-model-approach.html#cb50-23" tabindex="-1"></a><span class="fu">saveRDS</span>(dcrun.GSS, <span class="st">&quot;data/dcfitGSS_2022_OVEN_MBR.rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="hierarchical-model-approach.html#cb51-1" tabindex="-1"></a>dcrun.GSS <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/dcfitGSS_2022_OVEN_MBR.rds&quot;</span>)</span>
<span id="cb51-2"><a href="hierarchical-model-approach.html#cb51-2" tabindex="-1"></a></span>
<span id="cb51-3"><a href="hierarchical-model-approach.html#cb51-3" tabindex="-1"></a><span class="fu">summary</span>(dcrun.GSS);</span>
<span id="cb51-4"><a href="hierarchical-model-approach.html#cb51-4" tabindex="-1"></a><span class="fu">dcdiag</span>(dcrun.GSS) </span>
<span id="cb51-5"><a href="hierarchical-model-approach.html#cb51-5" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">dcdiag</span>(dcrun.GSS))</span>
<span id="cb51-6"><a href="hierarchical-model-approach.html#cb51-6" tabindex="-1"></a><span class="fu">pairs</span>(dcrun.GSS)</span>
<span id="cb51-7"><a href="hierarchical-model-approach.html#cb51-7" tabindex="-1"></a><span class="fu">coef</span>(dcrun.GSS)</span></code></pre></div>
<div class="float">
<img src="figs/dc_GSS_parameters.jpeg" alt="Data cloning results for four parameters of GSS from point counts" />
<div class="figcaption">Data cloning results for four parameters of GSS from point counts</div>
</div>
<p>And with these coefficients of the model, we can estimate latent count trajectories with the Kalman filter structure. This Kalman filter structure allows simultaneous estimation of latent states for observed time steps and prediction for missing ones, leveraging the temporal correlation in the process model.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="hierarchical-model-approach.html#cb52-1" tabindex="-1"></a>Kalman.pred.fn <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb52-2"><a href="hierarchical-model-approach.html#cb52-2" tabindex="-1"></a><span class="co"># Priors on model parameters: they are on the real line.</span></span>
<span id="cb52-3"><a href="hierarchical-model-approach.html#cb52-3" tabindex="-1"></a>  parms <span class="sc">~</span> <span class="fu">dmnorm</span>(MuPost,PrecPost)</span>
<span id="cb52-4"><a href="hierarchical-model-approach.html#cb52-4" tabindex="-1"></a>  a1 <span class="ot">&lt;-</span> parms[<span class="dv">1</span>]   </span>
<span id="cb52-5"><a href="hierarchical-model-approach.html#cb52-5" tabindex="-1"></a>  c1 <span class="ot">&lt;-</span> parms[<span class="dv">2</span>] </span>
<span id="cb52-6"><a href="hierarchical-model-approach.html#cb52-6" tabindex="-1"></a>  sig1 <span class="ot">&lt;-</span> parms[<span class="dv">3</span>]</span>
<span id="cb52-7"><a href="hierarchical-model-approach.html#cb52-7" tabindex="-1"></a>  stovar1 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">pow</span>(sig1,<span class="dv">2</span>)</span>
<span id="cb52-8"><a href="hierarchical-model-approach.html#cb52-8" tabindex="-1"></a>  tau1 <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb52-9"><a href="hierarchical-model-approach.html#cb52-9" tabindex="-1"></a>  </span>
<span id="cb52-10"><a href="hierarchical-model-approach.html#cb52-10" tabindex="-1"></a>  <span class="co"># Likelihood</span></span>
<span id="cb52-11"><a href="hierarchical-model-approach.html#cb52-11" tabindex="-1"></a>  mean_X1[<span class="dv">1</span>] <span class="ot">&lt;-</span> a1<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>c1) <span class="co"># Expected value of the first realization of the process</span></span>
<span id="cb52-12"><a href="hierarchical-model-approach.html#cb52-12" tabindex="-1"></a>    <span class="co"># this is drawn from the stationary distribution of the process</span></span>
<span id="cb52-13"><a href="hierarchical-model-approach.html#cb52-13" tabindex="-1"></a>    <span class="co"># Equation 14 (main text) and  A.4 in Appendix of Dennis et al 2006</span></span>
<span id="cb52-14"><a href="hierarchical-model-approach.html#cb52-14" tabindex="-1"></a>    Varno1 <span class="ot">&lt;-</span> <span class="fu">pow</span>(sig1,<span class="dv">2</span>)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">pow</span>(c1,<span class="dv">2</span>)) <span class="co">#. Equation A.5 in Appendix of Dennis et al 2006</span></span>
<span id="cb52-15"><a href="hierarchical-model-approach.html#cb52-15" tabindex="-1"></a>    </span>
<span id="cb52-16"><a href="hierarchical-model-approach.html#cb52-16" tabindex="-1"></a>    <span class="co"># Updating the state: Stochastic process for all time steps</span></span>
<span id="cb52-17"><a href="hierarchical-model-approach.html#cb52-17" tabindex="-1"></a>    X1[<span class="dv">1</span>]<span class="sc">~</span><span class="fu">dnorm</span>(mean_X1[<span class="dv">1</span>], <span class="dv">1</span><span class="sc">/</span>Varno1); <span class="co">#first estimation of population</span></span>
<span id="cb52-18"><a href="hierarchical-model-approach.html#cb52-18" tabindex="-1"></a>    C[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">exp</span>(X1[<span class="dv">1</span>])</span>
<span id="cb52-19"><a href="hierarchical-model-approach.html#cb52-19" tabindex="-1"></a>    <span class="co">#iteration of the GSS model in the data</span></span>
<span id="cb52-20"><a href="hierarchical-model-approach.html#cb52-20" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>qp1) {</span>
<span id="cb52-21"><a href="hierarchical-model-approach.html#cb52-21" tabindex="-1"></a>      mean_X1[t] <span class="ot">&lt;-</span> a1 <span class="sc">+</span> c1 <span class="sc">*</span> X1[(t <span class="sc">-</span> <span class="dv">1</span>)]</span>
<span id="cb52-22"><a href="hierarchical-model-approach.html#cb52-22" tabindex="-1"></a>      X1[t] <span class="sc">~</span> <span class="fu">dnorm</span>(mean_X1[t], stovar1) <span class="co"># Et is included here since a+cX(t-1) + Et ~ Normal(a+cX(t-1),sigma^2)</span></span>
<span id="cb52-23"><a href="hierarchical-model-approach.html#cb52-23" tabindex="-1"></a>      N[t] <span class="sc">~</span> <span class="fu">dpois</span>(<span class="fu">exp</span>(X1[t]))   <span class="co"># trick to convert continuous exp(X1) to integer counts as trials in binomial</span></span>
<span id="cb52-24"><a href="hierarchical-model-approach.html#cb52-24" tabindex="-1"></a>      Y1[(t<span class="dv">-1</span>)] <span class="sc">~</span> <span class="fu">dbin</span>(tau1, N[t])   <span class="co"># </span></span>
<span id="cb52-25"><a href="hierarchical-model-approach.html#cb52-25" tabindex="-1"></a>      C[t] <span class="ot">&lt;-</span> <span class="fu">exp</span>(X1[t]) <span class="co"># expected count</span></span>
<span id="cb52-26"><a href="hierarchical-model-approach.html#cb52-26" tabindex="-1"></a>    }</span>
<span id="cb52-27"><a href="hierarchical-model-approach.html#cb52-27" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="hierarchical-model-approach.html#cb53-1" tabindex="-1"></a>data4kalman <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">qp1 =</span> <span class="fu">as.numeric</span>(<span class="fu">length</span>(final_df<span class="sc">$</span>counts)),</span>
<span id="cb53-2"><a href="hierarchical-model-approach.html#cb53-2" tabindex="-1"></a>                    <span class="at">Y1 =</span> <span class="fu">array</span>(final_df<span class="sc">$</span>counts,</span>
<span id="cb53-3"><a href="hierarchical-model-approach.html#cb53-3" tabindex="-1"></a>                               <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">as.numeric</span>(<span class="fu">length</span>(final_df<span class="sc">$</span>counts)))),</span>
<span id="cb53-4"><a href="hierarchical-model-approach.html#cb53-4" tabindex="-1"></a>                    <span class="at">MuPost =</span> <span class="fu">coef</span>(dcrun.GSS),</span>
<span id="cb53-5"><a href="hierarchical-model-approach.html#cb53-5" tabindex="-1"></a>                    <span class="at">PrecPost =</span> <span class="fu">solve</span>(<span class="fu">vcov</span>(dcrun.GSS))) </span></code></pre></div>
<p>And run the Bayesian inference using the MLE from Data cloning</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="hierarchical-model-approach.html#cb54-1" tabindex="-1"></a>BH_DC_Pred <span class="ot">=</span> <span class="fu">jags.fit</span>(<span class="at">data=</span>data4kalman, </span>
<span id="cb54-2"><a href="hierarchical-model-approach.html#cb54-2" tabindex="-1"></a>                      <span class="at">params=</span><span class="fu">c</span>(<span class="st">&quot;C&quot;</span>), </span>
<span id="cb54-3"><a href="hierarchical-model-approach.html#cb54-3" tabindex="-1"></a>                      <span class="at">model=</span>Kalman.pred.fn)</span></code></pre></div>
<p>And we can generate a dataframe of the time series with the estimates, inter quartile range, and observed data through time</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="hierarchical-model-approach.html#cb55-1" tabindex="-1"></a><span class="fu">summary</span>(BH_DC_Pred)</span>
<span id="cb55-2"><a href="hierarchical-model-approach.html#cb55-2" tabindex="-1"></a><span class="co"># extract predictions and CI around them</span></span>
<span id="cb55-3"><a href="hierarchical-model-approach.html#cb55-3" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">mcmcapply</span>(BH_DC_Pred, quantile, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))))</span>
<span id="cb55-4"><a href="hierarchical-model-approach.html#cb55-4" tabindex="-1"></a></span>
<span id="cb55-5"><a href="hierarchical-model-approach.html#cb55-5" tabindex="-1"></a>ExpectedCounts <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(final_df,pred))</span>
<span id="cb55-6"><a href="hierarchical-model-approach.html#cb55-6" tabindex="-1"></a><span class="co"># modify names </span></span>
<span id="cb55-7"><a href="hierarchical-model-approach.html#cb55-7" tabindex="-1"></a><span class="fu">names</span>(ExpectedCounts) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>,<span class="st">&quot;Time_w_alone&quot;</span>,<span class="st">&quot;site_name&quot;</span>,<span class="st">&quot;site_id&quot;</span>,</span>
<span id="cb55-8"><a href="hierarchical-model-approach.html#cb55-8" tabindex="-1"></a>                          <span class="st">&quot;visit_number&quot;</span>,<span class="st">&quot;common_name&quot;</span>,<span class="st">&quot;time_window&quot;</span>,</span>
<span id="cb55-9"><a href="hierarchical-model-approach.html#cb55-9" tabindex="-1"></a>                          <span class="st">&quot;Observed&quot;</span>,</span>
<span id="cb55-10"><a href="hierarchical-model-approach.html#cb55-10" tabindex="-1"></a>                          <span class="st">&quot;acous_detections&quot;</span>,<span class="st">&quot;DateTime&quot;</span>,<span class="st">&quot;Time_window&quot;</span>, <span class="st">&quot;year&quot;</span>,</span>
<span id="cb55-11"><a href="hierarchical-model-approach.html#cb55-11" tabindex="-1"></a>                          <span class="st">&quot;time_id&quot;</span>,<span class="st">&quot;Lower&quot;</span>, <span class="st">&quot;Estimated&quot;</span>, <span class="st">&quot;Upper&quot;</span>)</span>
<span id="cb55-12"><a href="hierarchical-model-approach.html#cb55-12" tabindex="-1"></a></span>
<span id="cb55-13"><a href="hierarchical-model-approach.html#cb55-13" tabindex="-1"></a></span>
<span id="cb55-14"><a href="hierarchical-model-approach.html#cb55-14" tabindex="-1"></a>ExpectedCounts <span class="sc">|&gt;</span></span>
<span id="cb55-15"><a href="hierarchical-model-approach.html#cb55-15" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(Lower, Estimated, Upper, Observed),</span>
<span id="cb55-16"><a href="hierarchical-model-approach.html#cb55-16" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">&quot;Abundance&quot;</span>,</span>
<span id="cb55-17"><a href="hierarchical-model-approach.html#cb55-17" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">&quot;Count&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb55-18"><a href="hierarchical-model-approach.html#cb55-18" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> DateTime, </span>
<span id="cb55-19"><a href="hierarchical-model-approach.html#cb55-19" tabindex="-1"></a>             <span class="at">y =</span> Count, </span>
<span id="cb55-20"><a href="hierarchical-model-approach.html#cb55-20" tabindex="-1"></a>             <span class="at">color =</span> <span class="fu">factor</span>(Abundance,</span>
<span id="cb55-21"><a href="hierarchical-model-approach.html#cb55-21" tabindex="-1"></a>                            <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span>,</span>
<span id="cb55-22"><a href="hierarchical-model-approach.html#cb55-22" tabindex="-1"></a>                                       <span class="st">&quot;Upper&quot;</span>,</span>
<span id="cb55-23"><a href="hierarchical-model-approach.html#cb55-23" tabindex="-1"></a>                                       <span class="st">&quot;Estimated&quot;</span>,</span>
<span id="cb55-24"><a href="hierarchical-model-approach.html#cb55-24" tabindex="-1"></a>                                       <span class="st">&quot;Lower&quot;</span>)))) <span class="sc">+</span></span>
<span id="cb55-25"><a href="hierarchical-model-approach.html#cb55-25" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">linetype =</span> <span class="fu">factor</span>(Abundance,</span>
<span id="cb55-26"><a href="hierarchical-model-approach.html#cb55-26" tabindex="-1"></a>                            <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span>,</span>
<span id="cb55-27"><a href="hierarchical-model-approach.html#cb55-27" tabindex="-1"></a>                                       <span class="st">&quot;Upper&quot;</span>,</span>
<span id="cb55-28"><a href="hierarchical-model-approach.html#cb55-28" tabindex="-1"></a>                                       <span class="st">&quot;Estimated&quot;</span>,</span>
<span id="cb55-29"><a href="hierarchical-model-approach.html#cb55-29" tabindex="-1"></a>                                       <span class="st">&quot;Lower&quot;</span>)))) <span class="sc">+</span></span>
<span id="cb55-30"><a href="hierarchical-model-approach.html#cb55-30" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">shape =</span> <span class="fu">factor</span>(Abundance,</span>
<span id="cb55-31"><a href="hierarchical-model-approach.html#cb55-31" tabindex="-1"></a>                            <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span>,</span>
<span id="cb55-32"><a href="hierarchical-model-approach.html#cb55-32" tabindex="-1"></a>                                       <span class="st">&quot;Upper&quot;</span>,</span>
<span id="cb55-33"><a href="hierarchical-model-approach.html#cb55-33" tabindex="-1"></a>                                       <span class="st">&quot;Estimated&quot;</span>,</span>
<span id="cb55-34"><a href="hierarchical-model-approach.html#cb55-34" tabindex="-1"></a>                                       <span class="st">&quot;Lower&quot;</span>)))) <span class="sc">+</span></span>
<span id="cb55-35"><a href="hierarchical-model-approach.html#cb55-35" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;OVEN - Marsh-Billings-Rockefeller NHP - 2022 sampling&quot;</span>,</span>
<span id="cb55-36"><a href="hierarchical-model-approach.html#cb55-36" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">&quot;Time (sampling window)&quot;</span>,</span>
<span id="cb55-37"><a href="hierarchical-model-approach.html#cb55-37" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">&quot;Counts&quot;</span>,</span>
<span id="cb55-38"><a href="hierarchical-model-approach.html#cb55-38" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">&quot;Counts&quot;</span>,</span>
<span id="cb55-39"><a href="hierarchical-model-approach.html#cb55-39" tabindex="-1"></a>         <span class="at">linetype =</span> <span class="st">&quot;Counts&quot;</span>,</span>
<span id="cb55-40"><a href="hierarchical-model-approach.html#cb55-40" tabindex="-1"></a>         <span class="at">shape =</span> <span class="st">&quot;Counts&quot;</span>) <span class="sc">+</span></span>
<span id="cb55-41"><a href="hierarchical-model-approach.html#cb55-41" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="cn">NA</span>,<span class="st">&quot;dashed&quot;</span>,<span class="st">&quot;solid&quot;</span>,<span class="st">&quot;dashed&quot;</span>))<span class="sc">+</span></span>
<span id="cb55-42"><a href="hierarchical-model-approach.html#cb55-42" tabindex="-1"></a>    <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb55-43"><a href="hierarchical-model-approach.html#cb55-43" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;blue&quot;</span>,<span class="st">&quot;darkgray&quot;</span>,<span class="st">&quot;black&quot;</span>,<span class="st">&quot;darkgray&quot;</span>)) <span class="sc">+</span></span>
<span id="cb55-44"><a href="hierarchical-model-approach.html#cb55-44" tabindex="-1"></a>    <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb55-45"><a href="hierarchical-model-approach.html#cb55-45" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
</div>
<div id="coding-acoustic-detections-counts" class="section level3 hasAnchor" number="7.3.5">
<h3><span class="header-section-number">7.3.5</span> Coding Acoustic detections counts<a href="hierarchical-model-approach.html#coding-acoustic-detections-counts" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="hierarchical-model-approach.html#cb56-1" tabindex="-1"></a>StochGSS.acou.dc <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb56-2"><a href="hierarchical-model-approach.html#cb56-2" tabindex="-1"></a>  </span>
<span id="cb56-3"><a href="hierarchical-model-approach.html#cb56-3" tabindex="-1"></a>  <span class="co"># Priors on model parameters. Priors are DC1 in Lele et al (2007)</span></span>
<span id="cb56-4"><a href="hierarchical-model-approach.html#cb56-4" tabindex="-1"></a>  a1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>);        <span class="co"># constant, equivalent to the population growth rate. </span></span>
<span id="cb56-5"><a href="hierarchical-model-approach.html#cb56-5" tabindex="-1"></a>  c1 <span class="sc">~</span> <span class="fu">dunif</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>);       <span class="co"># constant, the density dependence parameter. </span></span>
<span id="cb56-6"><a href="hierarchical-model-approach.html#cb56-6" tabindex="-1"></a>  sig1 <span class="sc">~</span> <span class="fu">dlnorm</span>(<span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">10</span>); <span class="co">#variance parameter of stochastic  environment (process noise) in the system</span></span>
<span id="cb56-7"><a href="hierarchical-model-approach.html#cb56-7" tabindex="-1"></a>  stovar1 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">pow</span>(sig1,<span class="dv">2</span>)</span>
<span id="cb56-8"><a href="hierarchical-model-approach.html#cb56-8" tabindex="-1"></a>  </span>
<span id="cb56-9"><a href="hierarchical-model-approach.html#cb56-9" tabindex="-1"></a>   <span class="co"># Priors for observation model</span></span>
<span id="cb56-10"><a href="hierarchical-model-approach.html#cb56-10" tabindex="-1"></a>  alpha <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="fl">0.001</span>)  <span class="co"># intercept for scaling</span></span>
<span id="cb56-11"><a href="hierarchical-model-approach.html#cb56-11" tabindex="-1"></a>  gamma <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="fl">0.001</span>)  <span class="co"># slope linking latent state X_t to mean</span></span>
<span id="cb56-12"><a href="hierarchical-model-approach.html#cb56-12" tabindex="-1"></a>  r <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>,<span class="dv">50</span>)   <span class="co"># dispersion parameter for NegBin</span></span>
<span id="cb56-13"><a href="hierarchical-model-approach.html#cb56-13" tabindex="-1"></a>  </span>
<span id="cb56-14"><a href="hierarchical-model-approach.html#cb56-14" tabindex="-1"></a>  <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb56-15"><a href="hierarchical-model-approach.html#cb56-15" tabindex="-1"></a>    <span class="co"># Simulate trajectory that depends on the previous</span></span>
<span id="cb56-16"><a href="hierarchical-model-approach.html#cb56-16" tabindex="-1"></a>    mean_X1[<span class="dv">1</span>,k] <span class="ot">&lt;-</span> a1<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>c1) <span class="co"># Expected value of the first realization of the process</span></span>
<span id="cb56-17"><a href="hierarchical-model-approach.html#cb56-17" tabindex="-1"></a>    <span class="co"># this is drawn from the stationary distribution of the process</span></span>
<span id="cb56-18"><a href="hierarchical-model-approach.html#cb56-18" tabindex="-1"></a>    <span class="co"># Equation 14 (main text) and  A.4 in Appendix of Dennis et al 2006</span></span>
<span id="cb56-19"><a href="hierarchical-model-approach.html#cb56-19" tabindex="-1"></a>    Varno1[k] <span class="ot">&lt;-</span> <span class="fu">pow</span>(sig1,<span class="dv">2</span>)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">pow</span>(c1,<span class="dv">2</span>)) <span class="co">#. Equation A.5 in Appendix of Dennis et al 2006</span></span>
<span id="cb56-20"><a href="hierarchical-model-approach.html#cb56-20" tabindex="-1"></a>    </span>
<span id="cb56-21"><a href="hierarchical-model-approach.html#cb56-21" tabindex="-1"></a>    <span class="co"># Updating the state: Stochastic process for all time steps</span></span>
<span id="cb56-22"><a href="hierarchical-model-approach.html#cb56-22" tabindex="-1"></a>    X1[<span class="dv">1</span>,k]<span class="sc">~</span><span class="fu">dnorm</span>(mean_X1[<span class="dv">1</span>,k], <span class="dv">1</span><span class="sc">/</span>Varno1[k]); <span class="co">#first estimation of population</span></span>
<span id="cb56-23"><a href="hierarchical-model-approach.html#cb56-23" tabindex="-1"></a>    </span>
<span id="cb56-24"><a href="hierarchical-model-approach.html#cb56-24" tabindex="-1"></a>    <span class="co">#iteration of the GSS model in the data</span></span>
<span id="cb56-25"><a href="hierarchical-model-approach.html#cb56-25" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>qp1) {</span>
<span id="cb56-26"><a href="hierarchical-model-approach.html#cb56-26" tabindex="-1"></a>      mean_X1[t,k] <span class="ot">&lt;-</span> a1 <span class="sc">+</span> c1 <span class="sc">*</span> X1[(t <span class="sc">-</span> <span class="dv">1</span>),k]</span>
<span id="cb56-27"><a href="hierarchical-model-approach.html#cb56-27" tabindex="-1"></a>      X1[t,k] <span class="sc">~</span> <span class="fu">dnorm</span>(mean_X1[t,k], stovar1) <span class="co"># Et is included here since a+cX(t-1) + Et ~ Normal(a+cX(t-1),sigma^2)</span></span>
<span id="cb56-28"><a href="hierarchical-model-approach.html#cb56-28" tabindex="-1"></a>    }</span>
<span id="cb56-29"><a href="hierarchical-model-approach.html#cb56-29" tabindex="-1"></a>    </span>
<span id="cb56-30"><a href="hierarchical-model-approach.html#cb56-30" tabindex="-1"></a>    <span class="co"># Updating the observations, from the acoustic detections under Negative Binomial observation error</span></span>
<span id="cb56-31"><a href="hierarchical-model-approach.html#cb56-31" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>qp1) {</span>
<span id="cb56-32"><a href="hierarchical-model-approach.html#cb56-32" tabindex="-1"></a>      Y1[t,k] <span class="sc">~</span> <span class="fu">dnegbin</span>(p[t,k], r)</span>
<span id="cb56-33"><a href="hierarchical-model-approach.html#cb56-33" tabindex="-1"></a>      p[t,k] <span class="ot">&lt;-</span> r<span class="sc">/</span>(r<span class="sc">+</span>lambda[t,k])</span>
<span id="cb56-34"><a href="hierarchical-model-approach.html#cb56-34" tabindex="-1"></a>      <span class="fu">log</span>(lambda[t,k]) <span class="ot">&lt;-</span> alpha <span class="sc">+</span> gamma <span class="sc">*</span> X1[t,k]</span>
<span id="cb56-35"><a href="hierarchical-model-approach.html#cb56-35" tabindex="-1"></a>      }</span>
<span id="cb56-36"><a href="hierarchical-model-approach.html#cb56-36" tabindex="-1"></a>  }</span>
<span id="cb56-37"><a href="hierarchical-model-approach.html#cb56-37" tabindex="-1"></a>}</span></code></pre></div>
<p>For this model, we will need some initial values of the parameters, and given that there could be many <code>NA</code> a wrap to provide those initial guess values.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="hierarchical-model-approach.html#cb57-1" tabindex="-1"></a>guess.calc <span class="ot">&lt;-</span> <span class="cf">function</span>(Yobs,Tvec){</span>
<span id="cb57-2"><a href="hierarchical-model-approach.html#cb57-2" tabindex="-1"></a>  </span>
<span id="cb57-3"><a href="hierarchical-model-approach.html#cb57-3" tabindex="-1"></a>  T.t <span class="ot">&lt;-</span>Tvec<span class="sc">-</span>Tvec[<span class="dv">1</span>]; <span class="co">#  For calculations, time starts at zero.</span></span>
<span id="cb57-4"><a href="hierarchical-model-approach.html#cb57-4" tabindex="-1"></a>  q <span class="ot">&lt;-</span> <span class="fu">length</span>(Yobs)<span class="sc">-</span><span class="dv">1</span>;      <span class="co">#  Number of time series transitions, q.</span></span>
<span id="cb57-5"><a href="hierarchical-model-approach.html#cb57-5" tabindex="-1"></a>  qp1 <span class="ot">&lt;-</span> q<span class="sc">+</span><span class="dv">1</span>;              <span class="co">#  q+1 gets used a lot, too.</span></span>
<span id="cb57-6"><a href="hierarchical-model-approach.html#cb57-6" tabindex="-1"></a>  S.t <span class="ot">&lt;-</span> T.t[<span class="dv">2</span><span class="sc">:</span>qp1]<span class="sc">-</span>T.t[<span class="dv">1</span><span class="sc">:</span>q];  <span class="co">#  Time intervals.</span></span>
<span id="cb57-7"><a href="hierarchical-model-approach.html#cb57-7" tabindex="-1"></a>  Ybar <span class="ot">&lt;-</span> <span class="fu">mean</span>(Yobs);</span>
<span id="cb57-8"><a href="hierarchical-model-approach.html#cb57-8" tabindex="-1"></a>  Yvar <span class="ot">&lt;-</span> <span class="fu">sum</span>((Yobs<span class="sc">-</span>Ybar)<span class="sc">*</span>(Yobs<span class="sc">-</span>Ybar))<span class="sc">/</span>q;</span>
<span id="cb57-9"><a href="hierarchical-model-approach.html#cb57-9" tabindex="-1"></a>  mu1 <span class="ot">&lt;-</span> Ybar;</span>
<span id="cb57-10"><a href="hierarchical-model-approach.html#cb57-10" tabindex="-1"></a>  </span>
<span id="cb57-11"><a href="hierarchical-model-approach.html#cb57-11" tabindex="-1"></a>  <span class="co"># Kludge an initial value for theta based on mean of Y(t+s) given Y(t).</span></span>
<span id="cb57-12"><a href="hierarchical-model-approach.html#cb57-12" tabindex="-1"></a>  th1<span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">mean</span>(<span class="fu">log</span>(<span class="fu">abs</span>((Yobs[<span class="dv">2</span><span class="sc">:</span>qp1]<span class="sc">-</span>mu1)<span class="sc">/</span>(Yobs[<span class="dv">1</span><span class="sc">:</span>q]<span class="sc">-</span>mu1)))<span class="sc">/</span>S.t);            </span>
<span id="cb57-13"><a href="hierarchical-model-approach.html#cb57-13" tabindex="-1"></a>  bsq1<span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>th1<span class="sc">*</span>Yvar<span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>th1);         <span class="co"># Moment estimate using stationary</span></span>
<span id="cb57-14"><a href="hierarchical-model-approach.html#cb57-14" tabindex="-1"></a>  tsq1<span class="ot">&lt;-</span> bsq1;                         <span class="co">#   variance, with betasq=tausq.</span></span>
<span id="cb57-15"><a href="hierarchical-model-approach.html#cb57-15" tabindex="-1"></a>  </span>
<span id="cb57-16"><a href="hierarchical-model-approach.html#cb57-16" tabindex="-1"></a>  <span class="co">#three 0&#39;s </span></span>
<span id="cb57-17"><a href="hierarchical-model-approach.html#cb57-17" tabindex="-1"></a>  three0s <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">c</span>(th1,bsq1,tsq1))</span>
<span id="cb57-18"><a href="hierarchical-model-approach.html#cb57-18" tabindex="-1"></a>  <span class="cf">if</span>(three0s<span class="sc">==</span><span class="dv">0</span><span class="sc">|</span><span class="fu">is.na</span>(three0s)){th1 <span class="ot">&lt;-</span> <span class="fl">0.5</span>;bsq1 <span class="ot">&lt;-</span> <span class="fl">0.09</span>; tsq1 <span class="ot">&lt;-</span> <span class="fl">0.23</span>;}</span>
<span id="cb57-19"><a href="hierarchical-model-approach.html#cb57-19" tabindex="-1"></a>  </span>
<span id="cb57-20"><a href="hierarchical-model-approach.html#cb57-20" tabindex="-1"></a>  </span>
<span id="cb57-21"><a href="hierarchical-model-approach.html#cb57-21" tabindex="-1"></a>  out1 <span class="ot">&lt;-</span> <span class="fu">c</span>(th1,bsq1,tsq1);</span>
<span id="cb57-22"><a href="hierarchical-model-approach.html#cb57-22" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">sum</span>(out1<span class="sc">&lt;</span><span class="fl">1e-7</span>)<span class="sc">&gt;=</span><span class="dv">1</span>){out1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">0.09</span>,<span class="fl">0.23</span>)}</span>
<span id="cb57-23"><a href="hierarchical-model-approach.html#cb57-23" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">c</span>(mu1,out1);</span>
<span id="cb57-24"><a href="hierarchical-model-approach.html#cb57-24" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">abs</span>(out))</span>
<span id="cb57-25"><a href="hierarchical-model-approach.html#cb57-25" tabindex="-1"></a>  </span>
<span id="cb57-26"><a href="hierarchical-model-approach.html#cb57-26" tabindex="-1"></a>}</span>
<span id="cb57-27"><a href="hierarchical-model-approach.html#cb57-27" tabindex="-1"></a></span>
<span id="cb57-28"><a href="hierarchical-model-approach.html#cb57-28" tabindex="-1"></a>guess.calc2<span class="fl">.0</span><span class="ot">&lt;-</span> <span class="cf">function</span>(TimeAndNs){</span>
<span id="cb57-29"><a href="hierarchical-model-approach.html#cb57-29" tabindex="-1"></a>  </span>
<span id="cb57-30"><a href="hierarchical-model-approach.html#cb57-30" tabindex="-1"></a>  newmat <span class="ot">&lt;-</span> TimeAndNs </span>
<span id="cb57-31"><a href="hierarchical-model-approach.html#cb57-31" tabindex="-1"></a>  isnas <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(TimeAndNs))</span>
<span id="cb57-32"><a href="hierarchical-model-approach.html#cb57-32" tabindex="-1"></a>  </span>
<span id="cb57-33"><a href="hierarchical-model-approach.html#cb57-33" tabindex="-1"></a>  <span class="cf">if</span>(isnas <span class="sc">&gt;=</span> <span class="dv">1</span>){</span>
<span id="cb57-34"><a href="hierarchical-model-approach.html#cb57-34" tabindex="-1"></a>    </span>
<span id="cb57-35"><a href="hierarchical-model-approach.html#cb57-35" tabindex="-1"></a>    isnaind <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(TimeAndNs[,<span class="dv">2</span>]), <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb57-36"><a href="hierarchical-model-approach.html#cb57-36" tabindex="-1"></a>    newmat <span class="ot">&lt;-</span> TimeAndNs[<span class="sc">-</span>isnaind,]</span>
<span id="cb57-37"><a href="hierarchical-model-approach.html#cb57-37" tabindex="-1"></a>    newmat[,<span class="dv">1</span>] <span class="ot">&lt;-</span> newmat[,<span class="dv">1</span>] <span class="sc">-</span> newmat[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb57-38"><a href="hierarchical-model-approach.html#cb57-38" tabindex="-1"></a>    </span>
<span id="cb57-39"><a href="hierarchical-model-approach.html#cb57-39" tabindex="-1"></a>  }</span>
<span id="cb57-40"><a href="hierarchical-model-approach.html#cb57-40" tabindex="-1"></a>  </span>
<span id="cb57-41"><a href="hierarchical-model-approach.html#cb57-41" tabindex="-1"></a>  init.guess <span class="ot">&lt;-</span> <span class="fu">guess.calc</span>(<span class="at">Yobs =</span> <span class="fu">log</span>(newmat[,<span class="dv">2</span>]), <span class="at">Tvec=</span>newmat[,<span class="dv">1</span>])</span>
<span id="cb57-42"><a href="hierarchical-model-approach.html#cb57-42" tabindex="-1"></a>  </span>
<span id="cb57-43"><a href="hierarchical-model-approach.html#cb57-43" tabindex="-1"></a>  mu1  <span class="ot">&lt;-</span> init.guess[<span class="dv">1</span>]</span>
<span id="cb57-44"><a href="hierarchical-model-approach.html#cb57-44" tabindex="-1"></a>  th1  <span class="ot">&lt;-</span> init.guess[<span class="dv">2</span>]</span>
<span id="cb57-45"><a href="hierarchical-model-approach.html#cb57-45" tabindex="-1"></a>  bsq1 <span class="ot">&lt;-</span> init.guess[<span class="dv">3</span>]</span>
<span id="cb57-46"><a href="hierarchical-model-approach.html#cb57-46" tabindex="-1"></a>  sigsq1<span class="ot">&lt;-</span> ((<span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>th1))<span class="sc">*</span>bsq1)<span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>th1)</span>
<span id="cb57-47"><a href="hierarchical-model-approach.html#cb57-47" tabindex="-1"></a>  </span>
<span id="cb57-48"><a href="hierarchical-model-approach.html#cb57-48" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">mu=</span>mu1, <span class="at">theta=</span>th1, <span class="at">sigmasq =</span> sigsq1)</span>
<span id="cb57-49"><a href="hierarchical-model-approach.html#cb57-49" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb57-50"><a href="hierarchical-model-approach.html#cb57-50" tabindex="-1"></a>}</span></code></pre></div>
<p>And we have to bundle the data for Data cloning. Let’s fit the first species in the taxa with higher data (Ovenbird in Marsh-Billings-Rockefeller NHP) as a test.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="hierarchical-model-approach.html#cb58-1" tabindex="-1"></a>ts<span class="fl">.4</span>guess  <span class="ot">&lt;-</span>  <span class="fu">as.numeric</span>(final_df<span class="sc">$</span>acous_detections)</span>
<span id="cb58-2"><a href="hierarchical-model-approach.html#cb58-2" tabindex="-1"></a>tvec4guess  <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ts<span class="fl">.4</span>guess)</span>
<span id="cb58-3"><a href="hierarchical-model-approach.html#cb58-3" tabindex="-1"></a>onets4guess <span class="ot">&lt;-</span> <span class="fu">cbind</span>(tvec4guess, ts<span class="fl">.4</span>guess)</span>
<span id="cb58-4"><a href="hierarchical-model-approach.html#cb58-4" tabindex="-1"></a>naive.guess <span class="ot">&lt;-</span> <span class="fu">guess.calc2.0</span>(<span class="at">TimeAndNs =</span> onets4guess)</span>
<span id="cb58-5"><a href="hierarchical-model-approach.html#cb58-5" tabindex="-1"></a></span>
<span id="cb58-6"><a href="hierarchical-model-approach.html#cb58-6" tabindex="-1"></a>datalistGSS.acou.dc <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">K =</span> <span class="dv">1</span>,</span>
<span id="cb58-7"><a href="hierarchical-model-approach.html#cb58-7" tabindex="-1"></a>                       <span class="at">qp1 =</span> <span class="fu">length</span>(ts<span class="fl">.4</span>guess),</span>
<span id="cb58-8"><a href="hierarchical-model-approach.html#cb58-8" tabindex="-1"></a>                       <span class="at">Y1 =</span> <span class="fu">dcdim</span>(<span class="fu">array</span>(ts<span class="fl">.4</span>guess,</span>
<span id="cb58-9"><a href="hierarchical-model-approach.html#cb58-9" tabindex="-1"></a>                                        <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">length</span>(ts<span class="fl">.4</span>guess),<span class="dv">1</span>)))) </span>
<span id="cb58-10"><a href="hierarchical-model-approach.html#cb58-10" tabindex="-1"></a></span>
<span id="cb58-11"><a href="hierarchical-model-approach.html#cb58-11" tabindex="-1"></a>dcrun.GSS.acou <span class="ot">&lt;-</span> <span class="fu">dc.fit</span>(<span class="at">data =</span> datalistGSS.acou.dc,</span>
<span id="cb58-12"><a href="hierarchical-model-approach.html#cb58-12" tabindex="-1"></a>                    <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;a1&quot;</span>, <span class="st">&quot;c1&quot;</span>, <span class="st">&quot;sig1&quot;</span>, <span class="st">&quot;gamma&quot;</span>, <span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;r&quot;</span>), </span>
<span id="cb58-13"><a href="hierarchical-model-approach.html#cb58-13" tabindex="-1"></a>                    <span class="at">model =</span> StochGSS.acou.dc, </span>
<span id="cb58-14"><a href="hierarchical-model-approach.html#cb58-14" tabindex="-1"></a>                    <span class="at">n.clones =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">20</span>),</span>
<span id="cb58-15"><a href="hierarchical-model-approach.html#cb58-15" tabindex="-1"></a>                    <span class="at">multiply =</span> <span class="st">&quot;K&quot;</span>,</span>
<span id="cb58-16"><a href="hierarchical-model-approach.html#cb58-16" tabindex="-1"></a>                    <span class="at">unchanged =</span> <span class="st">&quot;qp1&quot;</span>,</span>
<span id="cb58-17"><a href="hierarchical-model-approach.html#cb58-17" tabindex="-1"></a>                    <span class="at">n.chains =</span> <span class="dv">3</span>,</span>
<span id="cb58-18"><a href="hierarchical-model-approach.html#cb58-18" tabindex="-1"></a>                    <span class="at">n.adapt =</span> <span class="dv">5000</span>,</span>
<span id="cb58-19"><a href="hierarchical-model-approach.html#cb58-19" tabindex="-1"></a>                    <span class="at">n.update =</span> <span class="dv">100</span>,</span>
<span id="cb58-20"><a href="hierarchical-model-approach.html#cb58-20" tabindex="-1"></a>                    <span class="at">thin =</span> <span class="dv">20</span>,</span>
<span id="cb58-21"><a href="hierarchical-model-approach.html#cb58-21" tabindex="-1"></a>                    <span class="at">n.iter =</span> <span class="dv">20000</span>)</span>
<span id="cb58-22"><a href="hierarchical-model-approach.html#cb58-22" tabindex="-1"></a></span>
<span id="cb58-23"><a href="hierarchical-model-approach.html#cb58-23" tabindex="-1"></a><span class="fu">saveRDS</span>(dcrun.GSS.acou, <span class="st">&quot;data/dcfitGSS_AcDet_2022_OVEN_MBR.rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="hierarchical-model-approach.html#cb59-1" tabindex="-1"></a>dcrun.GSS.acou <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/dcfitGSS_AcDet_2022_OVEN_MBR.rds&quot;</span>)</span>
<span id="cb59-2"><a href="hierarchical-model-approach.html#cb59-2" tabindex="-1"></a></span>
<span id="cb59-3"><a href="hierarchical-model-approach.html#cb59-3" tabindex="-1"></a><span class="fu">summary</span>(dcrun.GSS.acou);</span>
<span id="cb59-4"><a href="hierarchical-model-approach.html#cb59-4" tabindex="-1"></a><span class="fu">dcdiag</span>(dcrun.GSS.acou) </span>
<span id="cb59-5"><a href="hierarchical-model-approach.html#cb59-5" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">dcdiag</span>(dcrun.GSS.acou))</span>
<span id="cb59-6"><a href="hierarchical-model-approach.html#cb59-6" tabindex="-1"></a><span class="fu">pairs</span>(dcrun.GSS.acou)</span>
<span id="cb59-7"><a href="hierarchical-model-approach.html#cb59-7" tabindex="-1"></a><span class="fu">coef</span>(dcrun.GSS.acou)</span></code></pre></div>
<div class="float">
<img src="figs/dc_GSS_AcouDet_parameters.jpeg" alt="Data cloning results for four parameters of GSS from acoustic detections" />
<div class="figcaption">Data cloning results for four parameters of GSS from acoustic detections</div>
</div>
<p>Although diagnostics for lambda.max decreases with more clones, the chains are not converging. It seems that this needs more iterations and change initial values.</p>
<p>Anyway, with these coefficients of the model, we can estimate latent count trajectories with the Kalman filter structure. This Kalman filter structure allows simultaneous estimation of latent states for observed time steps and prediction for missing ones, leveraging the temporal correlation in the process model.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="hierarchical-model-approach.html#cb60-1" tabindex="-1"></a>Kalman.pred.acou.fn <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb60-2"><a href="hierarchical-model-approach.html#cb60-2" tabindex="-1"></a><span class="co"># Priors on model parameters: they are on the real line.</span></span>
<span id="cb60-3"><a href="hierarchical-model-approach.html#cb60-3" tabindex="-1"></a>  parms <span class="sc">~</span> <span class="fu">dmnorm</span>(MuPost,PrecPost)</span>
<span id="cb60-4"><a href="hierarchical-model-approach.html#cb60-4" tabindex="-1"></a>  a1 <span class="ot">&lt;-</span> parms[<span class="dv">1</span>]   </span>
<span id="cb60-5"><a href="hierarchical-model-approach.html#cb60-5" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> parms[<span class="dv">2</span>]   <span class="co"># intercept for scaling</span></span>
<span id="cb60-6"><a href="hierarchical-model-approach.html#cb60-6" tabindex="-1"></a>  c1 <span class="ot">&lt;-</span> parms[<span class="dv">3</span>] </span>
<span id="cb60-7"><a href="hierarchical-model-approach.html#cb60-7" tabindex="-1"></a>  gamma <span class="ot">&lt;-</span> parms[<span class="dv">4</span>]  <span class="co"># slope linking latent state X_t to mean</span></span>
<span id="cb60-8"><a href="hierarchical-model-approach.html#cb60-8" tabindex="-1"></a>  r <span class="ot">&lt;-</span> parms[<span class="dv">5</span>]      <span class="co"># overdispersion parameter for NegBinom</span></span>
<span id="cb60-9"><a href="hierarchical-model-approach.html#cb60-9" tabindex="-1"></a>  sig1 <span class="ot">&lt;-</span> parms[<span class="dv">6</span>]</span>
<span id="cb60-10"><a href="hierarchical-model-approach.html#cb60-10" tabindex="-1"></a>  stovar1 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">pow</span>(sig1,<span class="dv">2</span>)</span>
<span id="cb60-11"><a href="hierarchical-model-approach.html#cb60-11" tabindex="-1"></a></span>
<span id="cb60-12"><a href="hierarchical-model-approach.html#cb60-12" tabindex="-1"></a>  <span class="co"># Likelihood</span></span>
<span id="cb60-13"><a href="hierarchical-model-approach.html#cb60-13" tabindex="-1"></a>  mean_X1[<span class="dv">1</span>] <span class="ot">&lt;-</span> a1<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>c1) <span class="co"># Expected value of the first realization of the process</span></span>
<span id="cb60-14"><a href="hierarchical-model-approach.html#cb60-14" tabindex="-1"></a>    <span class="co"># this is drawn from the stationary distribution of the process</span></span>
<span id="cb60-15"><a href="hierarchical-model-approach.html#cb60-15" tabindex="-1"></a>    <span class="co"># Equation 14 (main text) and  A.4 in Appendix of Dennis et al 2006</span></span>
<span id="cb60-16"><a href="hierarchical-model-approach.html#cb60-16" tabindex="-1"></a>    Varno1 <span class="ot">&lt;-</span> <span class="fu">pow</span>(sig1,<span class="dv">2</span>)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">pow</span>(c1,<span class="dv">2</span>)) <span class="co">#. Equation A.5 in Appendix of Dennis et al 2006</span></span>
<span id="cb60-17"><a href="hierarchical-model-approach.html#cb60-17" tabindex="-1"></a>    </span>
<span id="cb60-18"><a href="hierarchical-model-approach.html#cb60-18" tabindex="-1"></a>    <span class="co"># Updating the state: Stochastic process for all time steps</span></span>
<span id="cb60-19"><a href="hierarchical-model-approach.html#cb60-19" tabindex="-1"></a>    X1[<span class="dv">1</span>]<span class="sc">~</span><span class="fu">dnorm</span>(mean_X1[<span class="dv">1</span>], <span class="dv">1</span><span class="sc">/</span>Varno1); <span class="co">#first estimation of population</span></span>
<span id="cb60-20"><a href="hierarchical-model-approach.html#cb60-20" tabindex="-1"></a>    <span class="fu">log</span>(lambda[<span class="dv">1</span>]) <span class="ot">&lt;-</span> alpha <span class="sc">+</span> gamma <span class="sc">*</span> X1[<span class="dv">1</span>]</span>
<span id="cb60-21"><a href="hierarchical-model-approach.html#cb60-21" tabindex="-1"></a>    C[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">log</span>(lambda[<span class="dv">1</span>])</span>
<span id="cb60-22"><a href="hierarchical-model-approach.html#cb60-22" tabindex="-1"></a>    <span class="co">#iteration of the GSS model in the data</span></span>
<span id="cb60-23"><a href="hierarchical-model-approach.html#cb60-23" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>qp1) {</span>
<span id="cb60-24"><a href="hierarchical-model-approach.html#cb60-24" tabindex="-1"></a>      mean_X1[t] <span class="ot">&lt;-</span> a1 <span class="sc">+</span> c1 <span class="sc">*</span> X1[(t <span class="sc">-</span> <span class="dv">1</span>)]</span>
<span id="cb60-25"><a href="hierarchical-model-approach.html#cb60-25" tabindex="-1"></a>      X1[t] <span class="sc">~</span> <span class="fu">dnorm</span>(mean_X1[t], stovar1) <span class="co"># Et is included here since a+cX(t-1) + Et ~ Normal(a+cX(t-1),sigma^2)</span></span>
<span id="cb60-26"><a href="hierarchical-model-approach.html#cb60-26" tabindex="-1"></a>      </span>
<span id="cb60-27"><a href="hierarchical-model-approach.html#cb60-27" tabindex="-1"></a>      Y1[(t<span class="dv">-1</span>)] <span class="sc">~</span> <span class="fu">dnegbin</span>(p[t], r)</span>
<span id="cb60-28"><a href="hierarchical-model-approach.html#cb60-28" tabindex="-1"></a>      p[t] <span class="ot">&lt;-</span> r<span class="sc">/</span>(r<span class="sc">+</span>lambda[t])</span>
<span id="cb60-29"><a href="hierarchical-model-approach.html#cb60-29" tabindex="-1"></a>      <span class="fu">log</span>(lambda[t]) <span class="ot">&lt;-</span> alpha <span class="sc">+</span> gamma <span class="sc">*</span> X1[t]</span>
<span id="cb60-30"><a href="hierarchical-model-approach.html#cb60-30" tabindex="-1"></a>      C[t] <span class="ot">&lt;-</span> <span class="fu">log</span>(lambda[t]) <span class="co"># expected count</span></span>
<span id="cb60-31"><a href="hierarchical-model-approach.html#cb60-31" tabindex="-1"></a>    }</span>
<span id="cb60-32"><a href="hierarchical-model-approach.html#cb60-32" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="hierarchical-model-approach.html#cb61-1" tabindex="-1"></a>data4kalmanAco <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">qp1 =</span> <span class="fu">as.numeric</span>(<span class="fu">length</span>(final_df<span class="sc">$</span>acous_detections)),</span>
<span id="cb61-2"><a href="hierarchical-model-approach.html#cb61-2" tabindex="-1"></a>                    <span class="at">Y1 =</span> <span class="fu">array</span>(final_df<span class="sc">$</span>acous_detections,</span>
<span id="cb61-3"><a href="hierarchical-model-approach.html#cb61-3" tabindex="-1"></a>                               <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">as.numeric</span>(<span class="fu">length</span>(final_df<span class="sc">$</span>acous_detections)))),</span>
<span id="cb61-4"><a href="hierarchical-model-approach.html#cb61-4" tabindex="-1"></a>                    <span class="at">MuPost =</span> <span class="fu">coef</span>(dcrun.GSS.acou),</span>
<span id="cb61-5"><a href="hierarchical-model-approach.html#cb61-5" tabindex="-1"></a>                    <span class="at">PrecPost =</span> <span class="fu">solve</span>(<span class="fu">vcov</span>(dcrun.GSS.acou))) </span></code></pre></div>
<p>And run the Bayesian inference using the MLE from Data cloning</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="hierarchical-model-approach.html#cb62-1" tabindex="-1"></a>BH_DC_Pred_Acou <span class="ot">=</span> <span class="fu">jags.fit</span>(<span class="at">data=</span>data4kalmanAco, </span>
<span id="cb62-2"><a href="hierarchical-model-approach.html#cb62-2" tabindex="-1"></a>                      <span class="at">params=</span><span class="fu">c</span>(<span class="st">&quot;C&quot;</span>), </span>
<span id="cb62-3"><a href="hierarchical-model-approach.html#cb62-3" tabindex="-1"></a>                      <span class="at">model=</span>Kalman.pred.acou.fn)</span></code></pre></div>
<p>And we can generate a dataframe of the time series with the estimates, inter quartile range, and observed data through time</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="hierarchical-model-approach.html#cb63-1" tabindex="-1"></a><span class="fu">summary</span>(BH_DC_Pred_Acou)</span>
<span id="cb63-2"><a href="hierarchical-model-approach.html#cb63-2" tabindex="-1"></a><span class="co"># extract predictions and CI around them</span></span>
<span id="cb63-3"><a href="hierarchical-model-approach.html#cb63-3" tabindex="-1"></a>predAcou <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">mcmcapply</span>(BH_DC_Pred_Acou, quantile, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))))</span>
<span id="cb63-4"><a href="hierarchical-model-approach.html#cb63-4" tabindex="-1"></a></span>
<span id="cb63-5"><a href="hierarchical-model-approach.html#cb63-5" tabindex="-1"></a></span>
<span id="cb63-6"><a href="hierarchical-model-approach.html#cb63-6" tabindex="-1"></a>ExpectedCountsAcou <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(ExpectedCounts,predAcou))</span>
<span id="cb63-7"><a href="hierarchical-model-approach.html#cb63-7" tabindex="-1"></a><span class="co"># modify names </span></span>
<span id="cb63-8"><a href="hierarchical-model-approach.html#cb63-8" tabindex="-1"></a><span class="fu">names</span>(ExpectedCountsAcou) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>,<span class="st">&quot;Time_w_alone&quot;</span>,<span class="st">&quot;site_name&quot;</span>,<span class="st">&quot;site_id&quot;</span>,</span>
<span id="cb63-9"><a href="hierarchical-model-approach.html#cb63-9" tabindex="-1"></a>                          <span class="st">&quot;visit_number&quot;</span>,<span class="st">&quot;common_name&quot;</span>,<span class="st">&quot;time_window&quot;</span>,</span>
<span id="cb63-10"><a href="hierarchical-model-approach.html#cb63-10" tabindex="-1"></a>                          <span class="st">&quot;Observed&quot;</span>,</span>
<span id="cb63-11"><a href="hierarchical-model-approach.html#cb63-11" tabindex="-1"></a>                          <span class="st">&quot;AcousticDetections&quot;</span>,</span>
<span id="cb63-12"><a href="hierarchical-model-approach.html#cb63-12" tabindex="-1"></a>                          <span class="st">&quot;DateTime&quot;</span>,<span class="st">&quot;Time_window&quot;</span>, <span class="st">&quot;year&quot;</span>,</span>
<span id="cb63-13"><a href="hierarchical-model-approach.html#cb63-13" tabindex="-1"></a>                          <span class="st">&quot;time_id&quot;</span>,</span>
<span id="cb63-14"><a href="hierarchical-model-approach.html#cb63-14" tabindex="-1"></a>                          <span class="st">&quot;CountLower&quot;</span>, <span class="st">&quot;CountEstimated&quot;</span>, <span class="st">&quot;CountUpper&quot;</span>,</span>
<span id="cb63-15"><a href="hierarchical-model-approach.html#cb63-15" tabindex="-1"></a>                          <span class="st">&quot;AcouDetLower&quot;</span>, <span class="st">&quot;AcouDetEstimated&quot;</span>, <span class="st">&quot;AcouDetUpper&quot;</span>)</span>
<span id="cb63-16"><a href="hierarchical-model-approach.html#cb63-16" tabindex="-1"></a></span>
<span id="cb63-17"><a href="hierarchical-model-approach.html#cb63-17" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">7</span>, <span class="dv">2</span>))  <span class="co"># low, left, up, right</span></span>
<span id="cb63-18"><a href="hierarchical-model-approach.html#cb63-18" tabindex="-1"></a></span>
<span id="cb63-19"><a href="hierarchical-model-approach.html#cb63-19" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb63-20"><a href="hierarchical-model-approach.html#cb63-20" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>Observed, </span>
<span id="cb63-21"><a href="hierarchical-model-approach.html#cb63-21" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#1b7837&quot;</span>, </span>
<span id="cb63-22"><a href="hierarchical-model-approach.html#cb63-22" tabindex="-1"></a>     <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">40</span>), </span>
<span id="cb63-23"><a href="hierarchical-model-approach.html#cb63-23" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">&quot;Counts&quot;</span>,</span>
<span id="cb63-24"><a href="hierarchical-model-approach.html#cb63-24" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;Time (sampling window)&quot;</span>)</span>
<span id="cb63-25"><a href="hierarchical-model-approach.html#cb63-25" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb63-26"><a href="hierarchical-model-approach.html#cb63-26" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>AcousticDetections, </span>
<span id="cb63-27"><a href="hierarchical-model-approach.html#cb63-27" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#762a83&quot;</span>)</span>
<span id="cb63-28"><a href="hierarchical-model-approach.html#cb63-28" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb63-29"><a href="hierarchical-model-approach.html#cb63-29" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>CountEstimated, </span>
<span id="cb63-30"><a href="hierarchical-model-approach.html#cb63-30" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#7fbf7b&quot;</span>)</span>
<span id="cb63-31"><a href="hierarchical-model-approach.html#cb63-31" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb63-32"><a href="hierarchical-model-approach.html#cb63-32" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>CountLower, </span>
<span id="cb63-33"><a href="hierarchical-model-approach.html#cb63-33" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#d9f0d3&quot;</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb63-34"><a href="hierarchical-model-approach.html#cb63-34" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb63-35"><a href="hierarchical-model-approach.html#cb63-35" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>CountUpper, </span>
<span id="cb63-36"><a href="hierarchical-model-approach.html#cb63-36" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#d9f0d3&quot;</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb63-37"><a href="hierarchical-model-approach.html#cb63-37" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb63-38"><a href="hierarchical-model-approach.html#cb63-38" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>AcouDetEstimated, </span>
<span id="cb63-39"><a href="hierarchical-model-approach.html#cb63-39" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#af8dc3&quot;</span>)</span>
<span id="cb63-40"><a href="hierarchical-model-approach.html#cb63-40" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb63-41"><a href="hierarchical-model-approach.html#cb63-41" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>AcouDetLower, </span>
<span id="cb63-42"><a href="hierarchical-model-approach.html#cb63-42" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#e7d4e8&quot;</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb63-43"><a href="hierarchical-model-approach.html#cb63-43" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb63-44"><a href="hierarchical-model-approach.html#cb63-44" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>AcouDetUpper, </span>
<span id="cb63-45"><a href="hierarchical-model-approach.html#cb63-45" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#e7d4e8&quot;</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb63-46"><a href="hierarchical-model-approach.html#cb63-46" tabindex="-1"></a></span>
<span id="cb63-47"><a href="hierarchical-model-approach.html#cb63-47" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x =</span> <span class="fu">min</span>(ExpectedCountsAcou<span class="sc">$</span>DateTime),</span>
<span id="cb63-48"><a href="hierarchical-model-approach.html#cb63-48" tabindex="-1"></a>       <span class="at">y =</span> <span class="dv">65</span>,</span>
<span id="cb63-49"><a href="hierarchical-model-approach.html#cb63-49" tabindex="-1"></a>       <span class="at">cex =</span> <span class="fl">0.7</span>, </span>
<span id="cb63-50"><a href="hierarchical-model-approach.html#cb63-50" tabindex="-1"></a>       <span class="at">pt.cex =</span> <span class="fl">0.7</span>,</span>
<span id="cb63-51"><a href="hierarchical-model-approach.html#cb63-51" tabindex="-1"></a>       <span class="at">xpd =</span> <span class="cn">TRUE</span>,</span>
<span id="cb63-52"><a href="hierarchical-model-approach.html#cb63-52" tabindex="-1"></a>       <span class="at">horiz =</span> <span class="cn">FALSE</span>,</span>
<span id="cb63-53"><a href="hierarchical-model-approach.html#cb63-53" tabindex="-1"></a>       <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&quot;Observed from point counts&quot;</span>, </span>
<span id="cb63-54"><a href="hierarchical-model-approach.html#cb63-54" tabindex="-1"></a>                  <span class="st">&quot;Acoustic detections&quot;</span>, </span>
<span id="cb63-55"><a href="hierarchical-model-approach.html#cb63-55" tabindex="-1"></a>                  <span class="st">&quot;Estimate from point counts&quot;</span>, </span>
<span id="cb63-56"><a href="hierarchical-model-approach.html#cb63-56" tabindex="-1"></a>                  <span class="st">&quot;Point count CI estimates&quot;</span>, </span>
<span id="cb63-57"><a href="hierarchical-model-approach.html#cb63-57" tabindex="-1"></a>                  <span class="st">&quot;Estimate from acoustic detections&quot;</span>, </span>
<span id="cb63-58"><a href="hierarchical-model-approach.html#cb63-58" tabindex="-1"></a>                  <span class="st">&quot;Acoustic detections CI estimates&quot;</span>),</span>
<span id="cb63-59"><a href="hierarchical-model-approach.html#cb63-59" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">&quot;#1b7837&quot;</span>, </span>
<span id="cb63-60"><a href="hierarchical-model-approach.html#cb63-60" tabindex="-1"></a>               <span class="st">&quot;#762a83&quot;</span>, </span>
<span id="cb63-61"><a href="hierarchical-model-approach.html#cb63-61" tabindex="-1"></a>               <span class="st">&quot;#7fbf7b&quot;</span>, </span>
<span id="cb63-62"><a href="hierarchical-model-approach.html#cb63-62" tabindex="-1"></a>               <span class="st">&quot;#d9f0d3&quot;</span>, </span>
<span id="cb63-63"><a href="hierarchical-model-approach.html#cb63-63" tabindex="-1"></a>               <span class="st">&quot;#af8dc3&quot;</span>, </span>
<span id="cb63-64"><a href="hierarchical-model-approach.html#cb63-64" tabindex="-1"></a>               <span class="st">&quot;#e7d4e8&quot;</span>),</span>
<span id="cb63-65"><a href="hierarchical-model-approach.html#cb63-65" tabindex="-1"></a>       <span class="at">lty =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>),   <span class="co"># NA for points, 1 for solid lines, 2 for dashed</span></span>
<span id="cb63-66"><a href="hierarchical-model-approach.html#cb63-66" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>), <span class="co"># symbols for points</span></span>
<span id="cb63-67"><a href="hierarchical-model-approach.html#cb63-67" tabindex="-1"></a>       <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)                     <span class="co"># no box around legend</span></span></code></pre></div>
<div class="float">
<img src="figs/ExpectedCountsOVEN_MBR_2022_a.jpeg" alt="Observed and estimated counts from point counts and acoustic detections - A" />
<div class="figcaption">Observed and estimated counts from point counts and acoustic detections - A</div>
</div>
<p>Cutting the edges to see the details of the estimates:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="hierarchical-model-approach.html#cb64-1" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">2</span>))  </span>
<span id="cb64-2"><a href="hierarchical-model-approach.html#cb64-2" tabindex="-1"></a></span>
<span id="cb64-3"><a href="hierarchical-model-approach.html#cb64-3" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb64-4"><a href="hierarchical-model-approach.html#cb64-4" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>Observed, </span>
<span id="cb64-5"><a href="hierarchical-model-approach.html#cb64-5" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#1b7837&quot;</span>, </span>
<span id="cb64-6"><a href="hierarchical-model-approach.html#cb64-6" tabindex="-1"></a>     <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">10</span>), </span>
<span id="cb64-7"><a href="hierarchical-model-approach.html#cb64-7" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">&quot;Counts&quot;</span>,</span>
<span id="cb64-8"><a href="hierarchical-model-approach.html#cb64-8" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;Time (sampling window)&quot;</span>, </span>
<span id="cb64-9"><a href="hierarchical-model-approach.html#cb64-9" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&quot;OVEN - 2022 - Marsh-Billings-Rockefeller NHP&quot;</span>)</span>
<span id="cb64-10"><a href="hierarchical-model-approach.html#cb64-10" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb64-11"><a href="hierarchical-model-approach.html#cb64-11" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>AcousticDetections, </span>
<span id="cb64-12"><a href="hierarchical-model-approach.html#cb64-12" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#762a83&quot;</span>)</span>
<span id="cb64-13"><a href="hierarchical-model-approach.html#cb64-13" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb64-14"><a href="hierarchical-model-approach.html#cb64-14" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>CountEstimated, </span>
<span id="cb64-15"><a href="hierarchical-model-approach.html#cb64-15" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#7fbf7b&quot;</span>)</span>
<span id="cb64-16"><a href="hierarchical-model-approach.html#cb64-16" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb64-17"><a href="hierarchical-model-approach.html#cb64-17" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>CountLower, </span>
<span id="cb64-18"><a href="hierarchical-model-approach.html#cb64-18" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#d9f0d3&quot;</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb64-19"><a href="hierarchical-model-approach.html#cb64-19" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb64-20"><a href="hierarchical-model-approach.html#cb64-20" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>CountUpper, </span>
<span id="cb64-21"><a href="hierarchical-model-approach.html#cb64-21" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#d9f0d3&quot;</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb64-22"><a href="hierarchical-model-approach.html#cb64-22" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb64-23"><a href="hierarchical-model-approach.html#cb64-23" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>AcouDetEstimated, </span>
<span id="cb64-24"><a href="hierarchical-model-approach.html#cb64-24" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#af8dc3&quot;</span>)</span>
<span id="cb64-25"><a href="hierarchical-model-approach.html#cb64-25" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb64-26"><a href="hierarchical-model-approach.html#cb64-26" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>AcouDetLower, </span>
<span id="cb64-27"><a href="hierarchical-model-approach.html#cb64-27" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#e7d4e8&quot;</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb64-28"><a href="hierarchical-model-approach.html#cb64-28" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> ExpectedCountsAcou<span class="sc">$</span>DateTime,</span>
<span id="cb64-29"><a href="hierarchical-model-approach.html#cb64-29" tabindex="-1"></a>     <span class="at">y =</span> ExpectedCountsAcou<span class="sc">$</span>AcouDetUpper, </span>
<span id="cb64-30"><a href="hierarchical-model-approach.html#cb64-30" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;#e7d4e8&quot;</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb64-31"><a href="hierarchical-model-approach.html#cb64-31" tabindex="-1"></a></span>
<span id="cb64-32"><a href="hierarchical-model-approach.html#cb64-32" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x =</span> <span class="fu">min</span>(ExpectedCountsAcou<span class="sc">$</span>DateTime),</span>
<span id="cb64-33"><a href="hierarchical-model-approach.html#cb64-33" tabindex="-1"></a>       <span class="at">y =</span> <span class="dv">10</span>,</span>
<span id="cb64-34"><a href="hierarchical-model-approach.html#cb64-34" tabindex="-1"></a>       <span class="at">cex =</span> <span class="fl">0.7</span>, </span>
<span id="cb64-35"><a href="hierarchical-model-approach.html#cb64-35" tabindex="-1"></a>       <span class="at">pt.cex =</span> <span class="fl">0.7</span>,</span>
<span id="cb64-36"><a href="hierarchical-model-approach.html#cb64-36" tabindex="-1"></a>       <span class="at">xpd =</span> <span class="cn">TRUE</span>,</span>
<span id="cb64-37"><a href="hierarchical-model-approach.html#cb64-37" tabindex="-1"></a>       <span class="at">horiz =</span> <span class="cn">FALSE</span>,</span>
<span id="cb64-38"><a href="hierarchical-model-approach.html#cb64-38" tabindex="-1"></a>       <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&quot;Observed from point counts&quot;</span>, </span>
<span id="cb64-39"><a href="hierarchical-model-approach.html#cb64-39" tabindex="-1"></a>                  <span class="st">&quot;Acoustic detections&quot;</span>, </span>
<span id="cb64-40"><a href="hierarchical-model-approach.html#cb64-40" tabindex="-1"></a>                  <span class="st">&quot;Estimate from point counts&quot;</span>, </span>
<span id="cb64-41"><a href="hierarchical-model-approach.html#cb64-41" tabindex="-1"></a>                  <span class="st">&quot;Point count CI estimates&quot;</span>, </span>
<span id="cb64-42"><a href="hierarchical-model-approach.html#cb64-42" tabindex="-1"></a>                  <span class="st">&quot;Estimate from acoustic detections&quot;</span>, </span>
<span id="cb64-43"><a href="hierarchical-model-approach.html#cb64-43" tabindex="-1"></a>                  <span class="st">&quot;Acoustic detections CI estimates&quot;</span>),</span>
<span id="cb64-44"><a href="hierarchical-model-approach.html#cb64-44" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">&quot;#1b7837&quot;</span>, </span>
<span id="cb64-45"><a href="hierarchical-model-approach.html#cb64-45" tabindex="-1"></a>               <span class="st">&quot;#762a83&quot;</span>, </span>
<span id="cb64-46"><a href="hierarchical-model-approach.html#cb64-46" tabindex="-1"></a>               <span class="st">&quot;#7fbf7b&quot;</span>, </span>
<span id="cb64-47"><a href="hierarchical-model-approach.html#cb64-47" tabindex="-1"></a>               <span class="st">&quot;#d9f0d3&quot;</span>, </span>
<span id="cb64-48"><a href="hierarchical-model-approach.html#cb64-48" tabindex="-1"></a>               <span class="st">&quot;#af8dc3&quot;</span>, </span>
<span id="cb64-49"><a href="hierarchical-model-approach.html#cb64-49" tabindex="-1"></a>               <span class="st">&quot;#e7d4e8&quot;</span>),</span>
<span id="cb64-50"><a href="hierarchical-model-approach.html#cb64-50" tabindex="-1"></a>       <span class="at">lty =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>),   <span class="co"># NA for points, 1 for solid lines, 2 for dashed</span></span>
<span id="cb64-51"><a href="hierarchical-model-approach.html#cb64-51" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>), <span class="co"># symbols for points</span></span>
<span id="cb64-52"><a href="hierarchical-model-approach.html#cb64-52" tabindex="-1"></a>       <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)                     <span class="co"># no box around legend</span></span></code></pre></div>
<div class="float">
<img src="figs/ExpectedCountsOVEN_MBR_2022_b.jpeg" alt="Observed and estimated counts from point counts and acoustic detections - B" />
<div class="figcaption">Observed and estimated counts from point counts and acoustic detections - B</div>
</div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="calling-rates.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="another-example-with-hierarchical-model-approach---oven-in-katahdin-woods-and-waters.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/vjjan91/newHampshire-pointCount-acoustics/edit/master/Counts_AcousticDetections_oac.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
