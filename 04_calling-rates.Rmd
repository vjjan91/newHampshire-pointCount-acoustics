---
editor_options: 
  chunk_output_type: console
---

# Calling rates

In this script, we compute calling rates and test if the relationship between predicted counts of individuals and acoustic detections is governed by calling activity. 

## Load necessary libraries  
```{r}
library(tidyverse)
library(dplyr)
library(stringr)
library(vegan)
library(scico)
library(data.table)
library(extrafont)
library(sf)
library(raster)
library(scales)
library(ggplot2)
library(ggspatial)
library(colorspace)
library(lubridate)
library(naniar)
library(patchwork)
library(ggrepel)
```

## Load previous model object and filtered data
```{r}
load("results/glmm_model_results.RData")
summary_stats <- read.csv("results/glmm_model_abundance_detections.csv")
data <- read.csv("results/datSubset.csv")

# we will also load the unfiltered acoustic data and point count data for calling rate calculation
unfiltered_data <- read.csv("results/pooled_pointCount_acoustic_data.csv")
```

## Calculating calling rate

Here, we estimate species-specific calling rate as the detections per minute per species and the corresponding visit. 

```{r}
# we work with the unfiltered data first to extract a detections per minute column for each species per visit
detections_per_minute <- unfiltered_data %>%
  filter(data_type == "acoustic_data") %>%
  mutate(minute = floor_date(as.POSIXct(begin_clock_time, format = "%H:%M:%S"), "minute")) %>%
  group_by(site_id, site_name, year, visit_number,
    scientific_name, common_name, 
    minute) %>%
  summarise(detections_per_minute = n(), .groups = 'drop')

# let's add the detections per minute or rate of detections for a species per visit back to the filtered data
data <- left_join(data, detections_per_minute) %>%
    replace_na(list(abundance = 0, detections_per_minute = 0))

# visualize calling rate across species
fig_callingRate <- data %>%
  filter(common_name != "Scarlet Tanager") %>% # since it was excluded from the GLMM
  ggplot(., aes(x = common_name, 
                              y = detections_per_minute)) +
  geom_boxplot(fill = "#D29C44FF") +  
  #facet_wrap(~site_name, scales ="free") +          
  theme_bw(base_family = "Century Gothic") +    
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    axis.title = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(
      size = 12,
      angle = 45,             
      hjust = 1,              
      face = "italic"         
    ),
    axis.text.y = element_text(size = 14),
    strip.text = element_text(size = 12, face = "bold")
  ) +
  labs(
    x = "Common Name",         
    y = "Calling rate (total detections per minute per visit)",        
    title = "Calling Rate by Species" 
  )

# Hermit thrush has the highest mean rate of calling per minute across the list of 21 species
ggsave(fig_callingRate, filename = "figs/callingRates-by-species.png", width = 12, height = 9, device = png(), units = "in", dpi = 300)
dev.off()
```


## Does calling rate vary as a function of number of individuals

Here, we expect that species-specific calling rate would increase with higher counts of individuals at a site. Alternately, there is no increase in the number of individuals and the same individual might produce no variation in calling rates per minute and we may see no relationship between the two. 

```{r}
# visualize detections per minute vs abundance by species
fig_det_rate_abundance <- data %>%
  filter(common_name != "Scarlet Tanager") %>% # since it was excluded from the GLMM
  ggplot(., aes(x = abundance, 
                y = detections_per_minute)) +
  geom_point(color = "#D29C44FF", alpha = 0.7, size = 2) +  
  geom_smooth(method = "lm", se = TRUE, color = "black", linewidth = 1) +
  facet_wrap(~common_name, scales = "free") +          
  theme_bw(base_family = "Century Gothic") +    
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    axis.title = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    strip.text = element_text(size = 12, face = "bold")
  ) +
  labs(
    x = "Abundance",         
    y = "Calling rate",        
    title = "Calling rate vs Abundance by Species" 
  )

# several species show an increase in rate of detections per minute with increasing number of individuals
ggsave(fig_det_rate_abundance, filename = "figs/calling-rate-vs-abundance-by-species.png", width = 14, height = 10, device = png(), units = "in", dpi = 300)
dev.off()
```


## Is calling rate linked to the fit between predicted abundance and acoustic detections?

Here, we ask if calling rate governs the strength of the relationship between predicted abundance and acoustic detections as estimated from the generalized linear mixed effect model (previous script)?

```{r}
# extract the mean, median, and max calling rate per species
calling_rate_summary <- data %>%
  filter(common_name != "Scarlet Tanager") %>%
  group_by(common_name) %>%
  summarise(
    mean_detections_per_minute = mean(detections_per_minute, na.rm = TRUE),
    median_detections_per_minute = median(detections_per_minute, na.rm = TRUE),
    max_detections_per_minute = max(detections_per_minute, na.rm = TRUE),
    n_observations = n(),
    .groups = 'drop'
  ) 

# join the psuedo r2 values and significance of fit to a single dataframe
for_plot <- left_join(summary_stats[,c(1,11,12)],calling_rate_summary,
                    by = c("Species" = "common_name"))

# note: we remove species that have a ns or no significant fit/association between predicted abundance and acoustic detections

# plot mean detections
fig_pseudoR2_mean_detections <- for_plot %>%
  filter(Significance != "ns") %>%
  ggplot(., aes(x = mean_detections_per_minute, y = Pseudo_R2)) +
  geom_point(color = "#D29C44FF", size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", se = TRUE, color = "black", linewidth = 1) +
  geom_text_repel(aes(label = Species), 
                  size = 3, 
                  fontface = "italic",
                  max.overlaps = 15) +  
  theme_bw(base_family = "Century Gothic") +
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    axis.title = element_text(size = 16, face = "bold"),
    axis.text = element_text(size = 12)
  ) +
  labs(
    x = "Mean Calling Rate (mean detections per minute)",
    y = "Pseudo R²",
    title = "Pseudo R² vs Mean Calling Rate Across Species"
  )

# negative association between pseudo R2 and mean detections per minute
ggsave(fig_pseudoR2_mean_detections, filename = "figs/pseudoR2-vs-mean-calling-rate.png", width = 12, height = 7, device = png(), units = "in", dpi = 300)
dev.off()

# max detections per minute 
fig_pseudoR2_max_detections <- for_plot %>%
  filter(Significance != "ns") %>%
  ggplot(., aes(x = max_detections_per_minute, y = Pseudo_R2)) +
  geom_point(color = "#D29C44FF", size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", se = TRUE, color = "black", linewidth = 1) +
  geom_text_repel(aes(label = Species), 
                  size = 3, 
                  fontface = "italic",
                  max.overlaps = 15) +  
  theme_bw(base_family = "Century Gothic") +
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    axis.title = element_text(size = 16, face = "bold"),
    axis.text = element_text(size = 12)
  ) +
  labs(
    x = "Max Calling Rate (max detections per minute)",
    y = "Pseudo R²",
    title = "Pseudo R² vs Max Calling Rate Across Species"
  )

# negative association between pseudo R2 and max detections per minute
ggsave(fig_pseudoR2_max_detections, filename = "figs/pseudoR2-vs-max-calling-rate.png", width = 12, height = 7, device = png(), units = "in", dpi = 300)
dev.off()
```





-do it per hour as well?
-then plot it against the number of individuals
-





