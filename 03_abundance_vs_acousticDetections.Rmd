---
editor_options: 
  chunk_output_type: console
---

# Abundance vs. acoustic detections

In this script, we will associations between abundance as estimated from point count data and acoustic detections, which were manually annotated from simultaneously paired audio recorders. 

## Load necessary libraries  
```{r}
library(tidyverse)
library(dplyr)
library(stringr)
library(vegan)
library(scico)
library(data.table)
library(extrafont)
library(sf)
library(raster)
library(scales)
library(ggplot2)
library(ggspatial)
library(colorspace)
library(lubridate)
library(naniar)
library(ggstatsplot)
library(patchwork)
library(glmmTMB)
library(lme4)
library(DHARMa)
library(performance)
```

## Load dataframe containing point count and acoustic data
```{r}
datSubset <- read.csv("results/datSubset.csv")
```

## Creating a single dataframe prior to running statistical analysis

```{r}
## filter out species that were only detected in one approach and not in the other

## Nine species were detected only in point count data but not in the acoustic data and can be ignored for downstream analysis: Herring Gull, Northern Cardinal, American Goshawk, Swamp Sparrow, Red-bellied Woodpecker, Pine Siskin, Savannah Sparrow, Eastern Kingbird, Brown-headed Cowbird
## we will remove the above list of species from the point count data
point_count <- datSubset %>%
  filter(data_type == "point_count") %>%
  filter(!common_name %in% c("Herring Gull", 
                             "Northern Cardinal", "American Goshawk", 
                             "Swamp Sparrow", "Red-bellied Woodpecker", 
                             "Pine Siskin",
                             "Savannah Sparrow", "Eastern Kingbird", 
                             "Brown-headed Cowbird"
                             ))

## Six species were detected only in acoustic data and not in the point count data and can also be ignored for downstream analysis: Cape May Warbler, Gray Catbird, Mallard, Prairie Warbler, House Wren, Bobolink
acoustic_data <- datSubset %>%
  filter(data_type == "acoustic_data") %>%
  filter(!common_name %in% c("Cape May Warbler", "Gray Catbird", 
                             "Mallard", "Prairie Warbler", 
                             "House Wren", "Bobolink"
                             ))

# estimate abundance for each species for each site/visit combination
# ignore distance for now as we can model it in future analysis
abundance <- point_count %>%
  group_by(site_id, site_name, year, visit_number,
           scientific_name,
           common_name) %>% 
  summarise(abundance = sum(abundance)) %>%
  ungroup()

# estimate detections for each species for each site and year combination using the manual annotations of the acoustic data
detections <- acoustic_data %>%
  group_by(site_id, site_name, year, visit_number,
           scientific_name,
           common_name) %>% 
  summarise(detections = n()) %>%
  ungroup()

## sanity check to ensure that we are not including any species in either data type by mistake
pc_not_aru <- unique(anti_join(abundance[,6], 
                               detections[,6]))
aru_not_pc <- unique(anti_join(detections[,6], 
                               abundance[,6]))
```

## Filtering criteria for species inclusion

How do we decide on the number of species to include or what species to keep? One criteria that was employed in Ramesh et al. 2022 (Ecography) was: "we kept only those species that occurred in at least 5% of all checklists across at least 27 unique grid cells (50% of the study area)." In a similar vein, we keep species occurring in atleast 10% or 25% of sites across both years for both acoustic data and point count data. 

```{r}
# add a total number of unique sites
# 104 unique sites
total_sites <- length(unique(abundance$site_id)) 

# how many sites was each species observed in when carrying out point counts and when carrying out manual acoustic annotations/detections?
species_year_pc <-  abundance %>%
  group_by(common_name, year) %>%
  summarise(n_sites = n_distinct(site_id), .groups = 'drop') %>%
  arrange(desc(n_sites)) %>%
   mutate(total_sites,
         prop_sites = n_sites/total_sites) # proportion of sites

species_year_aru <- detections %>%
  group_by(common_name, year) %>%
  summarise(n_sites = n_distinct(site_id), .groups = 'drop') %>%
  arrange(desc(n_sites)) %>%
  mutate(total_sites,
         prop_sites = n_sites/total_sites) # proportion of sites

# we choose to keep species that occurred in atleast 15% of sites in each method and within a year
species_pc <- species_year_pc %>%
  filter(prop_sites >= 0.15)

species_aru <- species_year_aru %>%
  filter(prop_sites >= 0.15)

# subset data from the abundance and detections dataframe to keep only species that occur in 15% of all sites during each year of survey
aru_subset <- detections %>%
  semi_join(species_aru, by = c("common_name", "year"))

pc_subset <- abundance %>%
  semi_join(species_pc, by = c("common_name", "year"))

# we only keep species that satisfied the criteria for both point counts and acoustic data. In some cases, a few species satisfied the criteria for only point counts or only acoustic data and such species were filtered out prior to other analyses

# how many species were detected in acoustic data but not point counts?
# no new species were matching the criteria in acoustic data
aru_not_pc <- unique(anti_join(aru_subset[,6], pc_subset[,6]))

# five species matched criteria in point counts that were not found in the acoustic data
pc_not_aru <- unique(anti_join(pc_subset[,6], aru_subset[,6]))

# removing these five species from the pc_subset
pc_subset <- pc_subset %>%
  filter(!common_name %in% c("Dark-eyed Junco","Red Crossbill",
                             "American Goldfinch","Wood Thrush",
                             "American Redstart"))

# create a single dataframe
data <- full_join(pc_subset, aru_subset) %>%
  replace_na(list(abundance = 0, detections = 0))

# criteria of 15% occurrence across sites per year/season for both acoustic data and point count data resulted in 22 species.
```

## Correlations between abundance and detections

Exploratory analysis of data distributions
```{r}
# explore the distribution of data
hist(data$abundance, main = "Abundance Distribution", xlab = "Abundance")
# most species had an abundance of 1, followed by 2 and feere species had higher abundances and so on

hist(data$detections, main = "Acoustic Detections Distribution", xlab = "Detections")
# right-tailed skewed distribution that is zero-inflated

plot(data$detections, data$abundance, 
     xlab = "Acoustic Detections", ylab = "Abundance")

# Check correlation
cor(data$abundance, data$detections, use = "complete.obs")

# 0.324 is the value of correlation between abundance and detections across species, sites and years.
```

## Scaling of predictors and determine distribution family

Since it's abundance, we will most likely choose Poisson, but we can do a quick assessment of the distribution to ensure we are choosing the right family prior to running mixed models.
```{r}
## we scale acoustic detections since the range is vastly different when compared to abundance (0-10 vs. 1-500 for example)
data$detections_scaled <- scale(data$detections)

# analyze abundance distribution to choose appropriate family
abundance_analysis <- function(y) {
  
  # summary statistics
  stats <- list(
    mean = mean(y, na.rm = TRUE),
    var = var(y, na.rm = TRUE),
    min = min(y, na.rm = TRUE),
    max = max(y, na.rm = TRUE),
    zeros = sum(y == 0, na.rm = TRUE),
    total_obs = length(y[!is.na(y)])
  )
  
  # dispersion ratio (variance/mean)
  stats$dispersion_ratio <- stats$var / stats$mean
  
  # proportion of zeros
  stats$zero_prop <- stats$zeros / stats$total_obs
  
  # recommendations based on characteristics
  if(stats$zero_prop > 0.2) {
    stats$recommended_family <- "Zero-inflated (zinb or zip)"
  } else if(stats$dispersion_ratio > 2) {
    stats$recommended_family <- "Negative Binomial"
  } else if(all(y >= 0) && stats$dispersion_ratio > 1) {
    stats$recommended_family <- "Poisson or Negative Binomial"
  } else {
    stats$recommended_family <- "Gaussian (if continuous) or Poisson (if counts)"
  }
  
  return(stats)
}

abundance_stats <- abundance_analysis(data$abundance)
print(abundance_stats)

# visualize to confirm
hist(data$abundance, main = "Abundance Distribution")
plot(table(data$abundance), main = "Abundance Frequency")
qqnorm(data$abundance)
qqline(data$abundance)

# we will choose a Poisson distribution given counts and variance is near the mean (0.8 and 1.4, a bit of a difference but since it is count data, that takes precedence)
```

## Generalized linear mixed model between abundance and acoustic detections

```{r}
# ensure factors are properly coded
data$common_name <- as.factor(data$common_name)
data$year <- as.factor(data$year)
data$site_id <- as.factor(data$site_id)

# poisson model
m1 <- glmmTMB(abundance ~ detections_scaled +
                            (1|common_name), 
                            data = data, family = gaussian)
summary(m1)

# model diagnostics
# DHARMa residuals
sim_resid <- simulateResiduals(m1)
plot(sim_resid, main = "DHARMa Residual Diagnostics")
  
# test for overdispersion
testDispersion(sim_resid)
  
# test for zero-inflation
testZeroInflation(sim_resid)
  
# performance metrics
r2_values <- r2(m1)
print(r2_values)
  
  return(sim_resid)
}

# Run diagnostics on best model
diagnostics <- model_diagnostics(best_model)


# Let's examine your abundance data more carefully
abundance_investigation <- function(data) {
  cat("=== DETAILED ABUNDANCE ANALYSIS ===\n")
  
  # Basic statistics
  cat("Abundance statistics:\n")
  cat("Mean:", mean(data$abundance, na.rm = TRUE), "\n")
  cat("Variance:", var(data$abundance, na.rm = TRUE), "\n")
  cat("Dispersion ratio (var/mean):", var(data$abundance, na.rm = TRUE) / mean(data$abundance, na.rm = TRUE), "\n")
  cat("Min:", min(data$abundance, na.rm = TRUE), "\n")
  cat("Max:", max(data$abundance, na.rm = TRUE), "\n")
  
  # Zero counts
  zeros <- sum(data$abundance == 0, na.rm = TRUE)
  total <- sum(!is.na(data$abundance))
  cat("Zeros:", zeros, "out of", total, "(", round(100*zeros/total, 1), "%)\n")
  
  # Distribution shape
  cat("\nValue frequencies (top 10):\n")
  print(head(sort(table(data$abundance), decreasing = TRUE), 10))
  
  # Check if it looks more like a different distribution
  cat("\nDistribution assessment:\n")
  
  # Test for normality (if continuous)
  if(length(unique(data$abundance)) > 20) {
    shapiro_p <- shapiro.test(sample(data$abundance, min(5000, length(data$abundance))))$p.value
    cat("Shapiro-Wilk normality test p-value:", shapiro_p, "\n")
  }
  
  # Visualizations
  par(mfrow = c(2, 3))
  
  # Histogram
  hist(data$abundance, main = "Abundance Distribution", 
       xlab = "Abundance", breaks = 30)
  
  # Bar plot of counts
  barplot(table(data$abundance)[1:min(20, length(table(data$abundance)))], 
          main = "Frequency of Abundance Values", xlab = "Abundance")
  
  # Q-Q plots against different distributions
  qqnorm(data$abundance, main = "Q-Q Plot: Normal")
  qqline(data$abundance)
  
  # Log-normal check (if no zeros)
  if(min(data$abundance, na.rm = TRUE) > 0) {
    qqnorm(log(data$abundance), main = "Q-Q Plot: Log-Normal")
    qqline(log(data$abundance))
  }
  
  # Poisson Q-Q plot
  lambda_est <- mean(data$abundance, na.rm = TRUE)
  theoretical_quantiles <- qpois(ppoints(length(data$abundance)), lambda = lambda_est)
  plot(sort(theoretical_quantiles), sort(data$abundance), 
       main = "Q-Q Plot: Poisson", xlab = "Theoretical Poisson", ylab = "Observed")
  abline(0, 1)
  
  # Mean-variance relationship by group
  if("species" %in% names(data)) {
    species_stats <- aggregate(abundance ~ species, data, function(x) c(mean = mean(x), var = var(x)))
    plot(species_stats$abundance[,"mean"], species_stats$abundance[,"var"],
         main = "Mean-Variance Relationship", xlab = "Mean", ylab = "Variance")
    abline(0, 1, col = "red", lty = 2)  # Poisson expectation
  }
  
  par(mfrow = c(1, 1))
  
  return(list(
    mean = mean(data$abundance, na.rm = TRUE),
    var = var(data$abundance, na.rm = TRUE),
    dispersion = var(data$abundance, na.rm = TRUE) / mean(data$abundance, na.rm = TRUE),
    zero_prop = zeros/total
  ))
}

abundance_stats <- abundance_investigation(data)




```





Here, we run a generalized linear mixed effects model to test for associations between abundance and acoustic detections

```{r}
## all birds model
m1 <- glmer(abundance ~ detections + (1|year) +
                (1|common_name) + (1|site_id),
              #ziformula = ~1,
              family=poisson(),
               data = data)

summary(m1)
plot_model(m1, type = "re")
plot(ggpredict(m1))




# Create a sequence of aruRate values for predictions
aruRate_seq <- seq(min(data$aruRate), max(data$aruRate), length.out = 100)

# Create a new data frame for predictions
new_data <- expand.grid(aruRate = aruRate_seq, common_name = unique(data$common_name))

# To make the predict function work we need to "recreate" a full dataset with dummy site_id values
site_ids_dummy <- unique(data$site_id)[1] # Use the first unique value of site_id

# Adding dummy site_id to new_data
new_data$site_id <- site_ids_dummy

# Add fixed effect predictions
new_data$predict_fixed <- predict(m1, newdata = new_data, re.form = NA)

# Extract random effects
ranef_common_name <- ranef(m1)$cond$common_name
ranef_common_name_data <- data.frame(common_name = rownames(ranef_common_name), ranef = ranef_common_name[,1])

# Merge random effects with new data
new_data <- merge(new_data, ranef_common_name_data, by = "common_name")

# Add random effects to the predictions
new_data$predict_all <- new_data$predict_fixed + new_data$ranef

# Calculate confidence intervals for fixed effects
pred_var <- predict(m1, newdata = new_data, re.form = NA, se.fit = TRUE)
new_data$ci_lower <- new_data$predict_fixed - 1.96 * pred_var$se.fit
new_data$ci_upper <- new_data$predict_fixed + 1.96 * pred_var$se.fit

# Plot using ggplot2 and facet by common_name
ggplot(new_data, aes(x = aruRate, y = exp(predict_all))) +
  geom_line() +
  geom_ribbon(aes(ymin = exp(ci_lower), ymax = exp(ci_upper)), alpha = 0.2) +
  facet_wrap(~ common_name) +
  theme_minimal() +
  labs(title = "Predicted Abundance by Common Name",
       y = "Predicted Abundance",
       x = "ARU Rate")

# Model diagnostics
library(DHARMa)
simulation_output <- simulateResiduals(fittedModel = m1)

# Plot residuals
plot(simulation_output)

# Perform tests
testUniformity(simulation_output)
testDispersion(simulation_output)
testZeroInflation(simulation_output)
```





## Species-specific correlations

Here, we run analysis correlating abundance and detections for each species across years. 
```{r}


# define color palette
colors <- c("#2d1b69", "#548150FF", "#DEB738FF","#852419FF")

# change structure of year (commenting it out for now)
# data$year <- as.factor(data$year)

# plots to be created species by species
plots <- list()

for(i in 1:length(unique(data$common_name))){
  
# extract species common name
a <- unique(data$common_name)[i]
  
# subset data for plotting
for_plot <- data[data$common_name==a,]

# visualization
plots[[i]] <- ggplot(for_plot, 
            aes(x = detections, y = abundance, color = site_name, 
                fill = site_name)) +
  geom_point(aes(shape = site_name), size = 3, alpha = 0.8) +
  
  # adding regression lines
  geom_smooth(method = "lm", se = TRUE, alpha = 0.15, linewidth = 1.2) +
  
  # adding RÂ² values for each line 
  stat_poly_eq(aes(label = after_stat(rr.label)), 
               formula = y ~ x,
               parse = TRUE,
               size = 3,
               label.x = 0.95,
               label.y = c(0.95, 0.85, 0.75, 0.65)) + 
  scale_color_manual(values = colors, name = "Site Name") +
  scale_fill_manual(values = colors, name = "Site Name") +
  scale_shape_manual(values = c(16, 17, 15, 18), name = "Site Name") +
  #facet_wrap(~year, scales = "free") +
  labs(
    x = "Acoustic detections",
    y = "Abundance (point-count)",
    title = a
  ) +
    theme_bw() +
  theme(
    text = element_text(family = "Century Gothic", size = 15, face = "bold"),
    plot.title = element_text(family = "Century Gothic", size = 18, face = "bold"),
    axis.title = element_text(family = "Century Gothic", size = 15, face = "bold"),
    legend.title = element_text(family = "Century Gothic", size = 12, face = "bold"),
    legend.text = element_text(family = "Century Gothic", size = 10),
    strip.text = element_text(family = "Century Gothic", size = 12, face = "bold"),
    panel.grid.minor = element_blank()
  )
}

# plot and save as a single pdf
cairo_pdf(
  filename = "figs/abundance-acousticDetections-by-species.pdf",
  width = 12, height = 8,
  onefile = TRUE
)
plots
dev.off() 
```

